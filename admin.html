<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-row:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Login Page -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h1>
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Admin Email" 
                    class="w-full p-3 border border-gray-300 rounded mb-4 focus:outline-none focus:border-blue-500">
                <button onclick="sendVerificationCode()" 
                    class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition">
                    Send Verification Code
                </button>
            </div>
            <div id="verificationForm" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Enter the 6-digit code sent to your email</p>
                <input type="text" id="verificationCode" placeholder="000000" maxlength="6"
                    class="w-full p-3 border border-gray-300 rounded mb-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500">
                <button onclick="verifyCode()" 
                    class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition">
                    Verify & Login
                </button>
                <button onclick="backToLogin()" 
                    class="w-full mt-2 text-sm text-gray-600 hover:text-gray-800">
                    ‚Üê Back to login
                </button>
            </div>
            <div id="loginMessage" class="mt-4 text-sm text-center"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center gap-4">
                    <span id="adminEmailDisplay" class="text-sm"></span>
                    <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white border-b">
            <div class="container mx-auto">
                <nav class="flex gap-4 p-4">
                    <button onclick="showTab('overview')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 font-semibold text-blue-600 bg-blue-50">
                        Overview
                    </button>
                    <button onclick="showTab('users')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        User List
                    </button>
                    <button onclick="showTab('email')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        Send Emails
                    </button>
                    <button onclick="showTab('sms')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        Send SMS
                    </button>
                    <button onclick="showTab('settings')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        Settings
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto p-6">
            
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Total Users</h3>
                        <p id="totalUsers" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Selected Users</h3>
                        <p id="selectedUsers" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Emails Sent Today</h3>
                        <p id="emailsSent" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="showTab('users')" class="p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 transition text-left">
                            <h3 class="font-semibold text-blue-600 mb-1">üìã View Users</h3>
                            <p class="text-sm text-gray-600">View and manage user list from Google Sheets</p>
                        </button>
                        <button onclick="showTab('email')" class="p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 transition text-left">
                            <h3 class="font-semibold text-green-600 mb-1">‚úâÔ∏è Send Email</h3>
                            <p class="text-sm text-gray-600">Compose and send emails to selected users</p>
                        </button>
                        <button onclick="loadUsersFromSheets()" class="p-4 border-2 border-purple-500 rounded-lg hover:bg-purple-50 transition text-left">
                            <h3 class="font-semibold text-purple-600 mb-1">üîÑ Refresh Data</h3>
                            <p class="text-sm text-gray-600">Reload user data from Google Sheets</p>
                        </button>
                        <button onclick="showTab('settings')" class="p-4 border-2 border-orange-500 rounded-lg hover:bg-orange-50 transition text-left">
                            <h3 class="font-semibold text-orange-600 mb-1">‚öôÔ∏è Settings</h3>
                            <p class="text-sm text-gray-600">Configure API keys and integrations</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User List</h2>
                        <div class="flex gap-2">
                            <button onclick="selectAll()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Select All
                            </button>
                            <button onclick="deselectAll()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Deselect All
                            </button>
                            <button onclick="loadUsersFromSheets()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="searchUsers" placeholder="Search users..." 
                            onkeyup="filterUsers()"
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3 text-left">
                                        <input type="checkbox" id="selectAllCheckbox" onclick="selectAll()">
                                    </th>
                                    <th class="p-3 text-left">Name</th>
                                    <th class="p-3 text-left">Email</th>
                                    <th class="p-3 text-left">Phone</th>
                                    <th class="p-3 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <tr>
                                    <td colspan="5" class="p-8 text-center text-gray-500">
                                        No users loaded. Please configure Google Sheets API in Settings.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="userCount" class="mt-4 text-sm text-gray-600"></div>
                </div>
            </div>

            <!-- Email Tab -->
            <div id="emailTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Send Email to Selected Users</h2>
                    
                    <div id="selectedUsersList" class="mb-4 p-4 bg-blue-50 rounded">
                        <h3 class="font-semibold mb-2">Selected Recipients: <span id="recipientCount">0</span></h3>
                        <div id="recipientEmails" class="text-sm text-gray-700"></div>
                    </div>

                    <form id="emailForm" onsubmit="sendEmails(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Subject</label>
                            <input type="text" id="emailSubject" required
                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                placeholder="Enter email subject">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Message</label>
                            <textarea id="emailMessage" rows="10" required
                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                placeholder="Enter your message here..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="includePersonalization">
                                <span class="text-sm">Include personalization (use {name} in message)</span>
                            </label>
                        </div>

                        <button type="submit" 
                            class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition font-semibold">
                            üìß Send Email to <span id="sendCount">0</span> Recipients
                        </button>
                    </form>

                    <div id="emailStatus" class="mt-4"></div>
                </div>
            </div>

            <!-- SMS Tab -->
            <div id="smsTab" class="tab-content">
              <h2 style="margin-top: 0;">üì± Send SMS Messages</h2>
              
              <!-- Info Box -->
              <div style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">üöÄ Queue-Based SMS System</div>
                <div style="color: #1e3a8a; font-size: 14px; line-height: 1.6;">
                  1. Select recipients and write your message<br>
                  2. Click "Queue Messages" to add jobs to the queue<br>
                  3. <a href="https://voice.google.com" target="_blank" style="color: #2563eb; font-weight: 600;">Open Google Voice in new tab ‚Üí</a><br>
                  4. Tampermonkey will automatically detect and send pending messages
                </div>
              </div>
            
              <!-- Recipients Selection -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px;">
                  üìã Select Recipients (with phone numbers only)
                </label>
                
                <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                  <button onclick="selectAllSMS()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Select All
                  </button>
                  <button onclick="deselectAllSMS()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Deselect All
                  </button>
                  <span id="smsSelectedCount" style="padding: 8px 16px; background: #f3f4f6; border-radius: 6px; font-weight: 600;">
                    0 selected
                  </span>
                </div>
            
                <div id="smsRecipientsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: white;">
                  <div style="color: #6b7280; text-align: center; padding: 20px;">
                    Load users first
                  </div>
                </div>
              </div>
            
              <!-- Message Template -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px;">
                  ‚úçÔ∏è Message Template
                </label>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                  Use {name}, {email}, {phone} for personalization
                </div>
                <textarea 
                  id="smsMessageTemplate" 
                  placeholder="Hi {name}, this is a message from Closing Coalition..."
                  style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; resize: vertical;"
                ></textarea>
                <div style="font-size: 13px; color: #6b7280; margin-top: 6px;">
                  Character count: <span id="smsCharCount">0</span>/160
                </div>
              </div>
            
              <!-- Queue Status -->
              <div id="smsQueueStatus" style="display: none; background: #f0fdf4; border: 1px solid #86efac; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #16a34a; margin-bottom: 8px;">
                  ‚úÖ Messages Queued Successfully!
                </div>
                <div id="smsQueueStatusText" style="color: #15803d; font-size: 14px;"></div>
              </div>
            
              <!-- Error Display -->
              <div id="smsError" style="display: none; background: #fef2f2; border: 1px solid #fca5a5; padding: 16px; border-radius: 8px; margin-bottom: 20px; color: #991b1b;">
              </div>
            
              <!-- Queue Button -->
              <div>
                <button 
                  id="queueSMSBtn" 
                  onclick="queueSMSMessages()"
                  style="padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);"
                >
                  üì§ Queue Messages
                </button>
                
                <a 
                  href="https://voice.google.com" 
                  target="_blank"
                  style="margin-left: 12px; padding: 14px 28px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-weight: 700; font-size: 16px; text-decoration: none; display: inline-block;"
                >
                  üåê Open Google Voice ‚Üí
                </a>
              </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-bold mb-4">API Configuration</h2>
                    
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
                        <h3 class="font-semibold mb-2">‚úÖ Connected Services</h3>
                        <div class="text-sm space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">‚óè</span>
                                <span>Cloudflare Worker API</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">‚óè</span>
                                <span>Google Apps Script Backend</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">‚óè</span>
                                <span>Google Sheets Database</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded">
                        <h3 class="font-semibold mb-2">API Endpoint</h3>
                        <code class="text-sm bg-white px-3 py-2 rounded border block break-all">
                            https://closing-coalition-api.thomaslancheros06.workers.dev/
                        </code>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded">
                        <h3 class="font-semibold mb-2">Google Sheets</h3>
                        <code class="text-sm bg-white px-3 py-2 rounded border block break-all">
                            https://script.google.com/macros/s/AKfycbzyOmxYVDoYJ6zmBMslbneUavlEKeWwplzA8zH8CvkXUx6sOTnfC7JPEsoTbjfJ2scvBQ/exec
                        </code>
                    </div>

                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
                        <h4 class="font-semibold text-sm mb-2">‚ÑπÔ∏è How It Works</h4>
                        <ol class="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                            <li>Admin dashboard sends requests to Cloudflare Worker</li>
                            <li>Cloudflare Worker forwards to Google Apps Script</li>
                            <li>Apps Script reads/writes to Google Sheets</li>
                            <li>Apps Script sends emails via Gmail</li>
                        </ol>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">System Actions</h2>
                    
                    <div class="space-y-3">
                        <button onclick="resetEmailCount()" 
                            class="w-full p-4 border-2 border-orange-500 rounded-lg hover:bg-orange-50 transition text-left">
                            <h3 class="font-semibold text-orange-600 mb-1">üîÑ Reset Email Counter</h3>
                            <p class="text-sm text-gray-600">Reset today's sent email count to 0</p>
                        </button>

                        <button onclick="clearCache()" 
                            class="w-full p-4 border-2 border-red-500 rounded-lg hover:bg-red-50 transition text-left">
                            <h3 class="font-semibold text-red-600 mb-1">üóëÔ∏è Clear Cache</h3>
                            <p class="text-sm text-gray-600">Clear all cached data and statistics</p>
                        </button>

                        <button onclick="loadUsersFromSheets()" 
                            class="w-full p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 transition text-left">
                            <h3 class="font-semibold text-green-600 mb-1">üì• Reload Users</h3>
                            <p class="text-sm text-gray-600">Fetch latest user data from Google Sheets</p>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://closing-coalition-api.thomaslancheros06.workers.dev/';
        const ADMIN_EMAIL = 'thomaslancheros.ail@gmail.com';
        let users = [];
        let selectedUserEmails = new Set();
        let verificationCodeSent = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // Authentication Functions
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('adminAuth') === 'true';
            const savedEmail = localStorage.getItem('adminEmail');
            
            if (isAuthenticated && savedEmail === ADMIN_EMAIL) {
                showDashboard();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('adminEmailDisplay').textContent = ADMIN_EMAIL;
            loadUsersFromSheets();
            updateStats();
        }

        async function sendVerificationCode() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showMessage('Please enter your email address', 'error');
                return;
            }

            if (email !== ADMIN_EMAIL) {
                showMessage('Unauthorized email address', 'error');
                return;
            }
            
            showMessage('Sending verification code...', 'info');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'sendVerification',
                        email: email
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('verificationForm').classList.remove('hidden');
                    showMessage('Verification code sent to your email!', 'success');
                } else {
                    showMessage(data.message || 'Failed to send verification code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error sending verification code. Please try again.', 'error');
            }
        }

        async function verifyCode() {
            const enteredCode = document.getElementById('verificationCode').value.trim();
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!enteredCode) {
                showMessage('Please enter the verification code', 'error');
                return;
            }

            showMessage('Verifying...', 'info');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verifyCode',
                        email: email,
                        code: enteredCode
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('adminAuth', 'true');
                    localStorage.setItem('adminEmail', ADMIN_EMAIL);
                    showMessage('Login successful!', 'success');
                    setTimeout(() => {
                        showDashboard();
                    }, 1000);
                } else {
                    showMessage(data.message || 'Invalid verification code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error verifying code. Please try again.', 'error');
            }
        }

        function backToLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('verificationForm').classList.add('hidden');
            document.getElementById('verificationCode').value = '';
            showMessage('', '');
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminEmail');
            showLogin();
            document.getElementById('loginEmail').value = '';
            document.getElementById('verificationCode').value = '';
            backToLogin();
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            messageDiv.className = `mt-4 text-sm text-center ${colors[type] || ''}`;
            messageDiv.textContent = message;
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active styling from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('font-semibold', 'text-blue-600', 'bg-blue-50');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active styling to clicked button
            event.target.classList.add('font-semibold', 'text-blue-600', 'bg-blue-50');
            
            // Update recipient lists based on tab
            if (tabName === 'email') {
                updateRecipientList();
            } else if (tabName === 'sms') {
                updateSmsRecipientList();
            }
        }

        // Configuration Functions
        function clearCache() {
            if (confirm('Are you sure you want to clear all cached data?')) {
                localStorage.removeItem('emailsSentToday');
                updateStats();
                alert('Cache cleared successfully!');
            }
        }

        function resetEmailCount() {
            if (confirm('Reset today\'s email count to 0?')) {
                localStorage.setItem('emailsSentToday', '0');
                updateStats();
                alert('Email count reset!');
            }
        }

        // ============================================================
        // SMS FUNCTIONS
        // ============================================================

        let googleVoiceWindow = null;
        let isGVWindowConnected = false;

        // Helper: Get selected users with phone numbers
        function getSelectedUsers() {
            return users.filter(u => selectedUserEmails.has(u.email));
        }

        // Helper: Normalize phone number (digits only)
        function normalizePhone(phone) {
            return String(phone || "").replace(/\D/g, "");
        }

        // Helper: Fill template with user data
        function fillTemplate(template, user) {
            return template
                .replace(/{name}/g, user?.name || "")
                .replace(/{email}/g, user?.email || "")
                .replace(/{phone}/g, user?.phone || "");
        }

        // Build SMS jobs from selected users
        function buildSmsJobs(template) {
            const selected = getSelectedUsers();

            const jobs = selected
                .map(u => ({
                    name: u.name,
                    phone: normalizePhone(u.phone),
                    message: fillTemplate(template, u)
                }))
                .filter(j => j.phone.length >= 10 && j.message.trim().length > 0);

            return jobs;
        }

        // Open Google Voice in popup window
        function openGoogleVoice() {
            // Close existing window if open
            if (googleVoiceWindow && !googleVoiceWindow.closed) {
                googleVoiceWindow.focus();
                return;
            }

            // Open new popup window
            const width = 800;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            googleVoiceWindow = window.open(
                'https://voice.google.com/u/0/messages',
                'GoogleVoiceWindow',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            if (googleVoiceWindow) {
                updateGVWindowStatus('Opening Google Voice...');
                
                // Check for connection
                setTimeout(() => {
                    if (googleVoiceWindow && !googleVoiceWindow.closed) {
                        updateGVWindowStatus('Connected! You can now send SMS.');
                        isGVWindowConnected = true;
                    }
                }, 2000);
            } else {
                alert('Failed to open Google Voice window. Please allow popups for this site.');
            }
        }

        // Update Google Voice window status display
        function updateGVWindowStatus(message, type = 'info') {
            const statusDiv = document.getElementById('gvWindowStatus');
            
            const colors = {
                info: 'bg-blue-50 border-blue-200',
                success: 'bg-green-50 border-green-200',
                error: 'bg-red-50 border-red-200',
                warning: 'bg-yellow-50 border-yellow-200'
            };

            const icons = {
                info: 'üì°',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };

            statusDiv.innerHTML = `
                <div class="p-4 ${colors[type]} border rounded-lg">
                    <p class="text-lg mb-2">${icons[type]} ${message}</p>
                    ${isGVWindowConnected ? `
                        <button onclick="openGoogleVoice()" 
                            class="text-sm px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Show Google Voice Window
                        </button>
                    ` : `
                        <button onclick="openGoogleVoice()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                            Open Google Voice Window
                        </button>
                    `}
                </div>
            `;
        }

        // Update SMS recipient list display
        function updateSmsRecipientList() {
            const selected = getSelectedUsers();
            const count = selected.length;
            
            document.getElementById('smsRecipientCount').textContent = count;
            document.getElementById('smsSendCount').textContent = count;
            
            const detailsDiv = document.getElementById('smsRecipientDetails');
            
            if (count === 0) {
                detailsDiv.innerHTML = '<p class="text-gray-500 italic">No users selected. Go to User List tab to select recipients.</p>';
                return;
            }
            
            // Show first 5 with phone numbers
            const withPhone = selected.filter(u => normalizePhone(u.phone).length >= 10);
            const withoutPhone = selected.filter(u => normalizePhone(u.phone).length < 10);
            
            let html = `<div class="space-y-1">`;
            
            if (withPhone.length > 0) {
                html += `<p class="font-semibold text-green-600">‚úì ${withPhone.length} with valid phone:</p>`;
                withPhone.slice(0, 5).forEach(u => {
                    html += `<p class="text-xs">‚Ä¢ ${u.name} - ${u.phone}</p>`;
                });
                if (withPhone.length > 5) {
                    html += `<p class="text-xs text-gray-500">... and ${withPhone.length - 5} more</p>`;
                }
            }
            
            if (withoutPhone.length > 0) {
                html += `<p class="font-semibold text-red-600 mt-2">‚úó ${withoutPhone.length} without phone:</p>`;
                withoutPhone.slice(0, 3).forEach(u => {
                    html += `<p class="text-xs">‚Ä¢ ${u.name}</p>`;
                });
                if (withoutPhone.length > 3) {
                    html += `<p class="text-xs text-gray-500">... and ${withoutPhone.length - 3} more</p>`;
                }
            }
            
            html += `</div>`;
            detailsDiv.innerHTML = html;
        }

        // Send SMS via Google Voice popup window
        function sendSmsMessages() {
            if (selectedUserEmails.size === 0) {
                alert('Please select at least one user to send SMS to');
                return;
            }

            const template = document.getElementById('smsMessage').value.trim();
            
            if (!template) {
                alert('Please enter a message');
                return;
            }

            // Check if Google Voice window is open
            if (!googleVoiceWindow || googleVoiceWindow.closed) {
                alert('Google Voice window is not open.\n\nClick "Open Google Voice" first, then try again.');
                openGoogleVoice();
                return;
            }

            const jobs = buildSmsJobs(template);

            if (jobs.length === 0) {
                alert('No valid phone numbers found for selected users.\n\nMake sure your users have phone numbers in the Google Sheet.');
                return;
            }

            // Show status
            const statusDiv = document.getElementById('smsStatus');
            statusDiv.innerHTML = `
                <div class="p-4 bg-blue-50 border border-blue-200 rounded">
                    <p class="font-semibold">üì± Sending ${jobs.length} SMS messages...</p>
                    <p class="text-sm mt-1">Check the Google Voice window for progress</p>
                    <div class="mt-2 bg-gray-200 rounded h-2">
                        <div id="smsProgressBar" class="bg-blue-500 h-2 rounded transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            `;

            // Send jobs to Tampermonkey script via postMessage
            try {
                googleVoiceWindow.postMessage({
                    type: "CC_SMS_JOBS",
                    jobs: jobs
                }, "*");

                console.log('[Admin] Sent SMS jobs to Google Voice window:', jobs);
                
                // Focus the Google Voice window so user can see it working
                googleVoiceWindow.focus();
            } catch (error) {
                console.error('[Admin] Error sending to Google Voice window:', error);
                statusDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded">
                        <p class="font-semibold text-red-800">‚ùå Error</p>
                        <p class="text-sm mt-1">Could not communicate with Google Voice window. Make sure it's open and Tampermonkey is installed.</p>
                    </div>
                `;
            }
        }

        // Listen for responses from Tampermonkey script
        window.addEventListener("message", (event) => {
            const data = event.data;
            if (!data) return;

            // SMS job completion
            if (data.type === "CC_SMS_DONE") {
                const statusDiv = document.getElementById('smsStatus');
                statusDiv.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded">
                        <p class="font-semibold text-green-800">‚úÖ SMS Campaign Complete!</p>
                        <p class="text-sm mt-1">Successfully sent: ${data.sent || 0}</p>
                        ${data.failed ? `<p class="text-sm text-red-600">Failed: ${data.failed}</p>` : ''}
                    </div>
                `;
                
                // Clear message after success
                document.getElementById('smsMessage').value = '';
            }

            // SMS progress update
            if (data.type === "CC_SMS_PROGRESS") {
                const progressBar = document.getElementById('smsProgressBar');
                if (progressBar && data.progress) {
                    progressBar.style.width = data.progress + '%';
                }
            }

            // SMS error
            if (data.type === "CC_SMS_ERROR") {
                const statusDiv = document.getElementById('smsStatus');
                statusDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded">
                        <p class="font-semibold text-red-800">‚ùå SMS Error</p>
                        <p class="text-sm mt-1">${data.message || 'Unknown error'}</p>
                    </div>
                `;
            }

            // Connection confirmation from Google Voice window
            if (data.type === "CC_SMS_READY") {
                isGVWindowConnected = true;
                updateGVWindowStatus('Connected! Google Voice is ready.', 'success');
            }
        });

        // Check if Google Voice window is still open periodically
        setInterval(() => {
            if (googleVoiceWindow && googleVoiceWindow.closed) {
                isGVWindowConnected = false;
                googleVoiceWindow = null;
            }
        }, 2000);

        // Reload Google Voice iframe (deprecated - kept for compatibility)
        function reloadGoogleVoice() {
            openGoogleVoice();
        }

        // Show Tampermonkey instructions
        function showTampermonkeyInstructions() {
            const instructions = `
üì± Tampermonkey Setup Instructions

STEP 1: Install Tampermonkey
‚Ä¢ Chrome: chrome.google.com/webstore (search "Tampermonkey")
‚Ä¢ Firefox: addons.mozilla.org (search "Tampermonkey")
‚Ä¢ Edge: microsoftedge.microsoft.com/addons (search "Tampermonkey")

STEP 2: Install SMS Bot Script
1. Click Tampermonkey icon in browser toolbar
2. Click "Create a new script"
3. Delete all the template code
4. Copy the entire "google-voice-bot.user.js" file
5. Paste it in
6. File > Save (or Ctrl+S)
7. Close the tab

STEP 3: Test It
1. Click "Open Google Voice" button above
2. Login to Google Voice in the popup
3. Come back to this page
4. Select users and send a test SMS!

Need the script file? Contact support or check the documentation.
            `;
            
            alert(instructions);
        }

        async function loadUsersFromSheets() {
            try {
                showMessage('Loading users...', 'info');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getUsers'
                    })
                });

                const data = await response.json();

                if (data.success && data.users) {
                    users = data.users.filter(user => user.email); // Only include users with email
                    displayUsers();
                    updateStats();
                    console.log(`Loaded ${users.length} users from Google Sheets`);
                } else {
                    console.error('Error loading users:', data.message);
                    alert('Error loading users: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users from Google Sheets. Please check your connection.');
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = 'user-row border-b';
                row.innerHTML = `
                    <td class="p-3">
                        <input type="checkbox" class="user-checkbox" data-email="${user.email}" 
                            onchange="toggleUserSelection('${user.email}')">
                    </td>
                    <td class="p-3">${user.name}</td>
                    <td class="p-3">${user.email}</td>
                    <td class="p-3">${user.phone}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('userCount').textContent = `Showing ${users.length} users`;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function selectAll() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                selectedUserEmails.add(checkbox.dataset.email);
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateStats();
            updateRecipientList();
        }

        function deselectAll() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            selectedUserEmails.clear();
            updateStats();
            updateRecipientList();
        }

        function toggleUserSelection(email) {
            if (selectedUserEmails.has(email)) {
                selectedUserEmails.delete(email);
            } else {
                selectedUserEmails.add(email);
            }
            updateStats();
            updateRecipientList();
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('selectedUsers').textContent = selectedUserEmails.size;
            
            const emailsSent = localStorage.getItem('emailsSentToday') || 0;
            document.getElementById('emailsSent').textContent = emailsSent;
        }

        function updateRecipientList() {
            const count = selectedUserEmails.size;
            document.getElementById('recipientCount').textContent = count;
            document.getElementById('sendCount').textContent = count;
            
            const emailsDiv = document.getElementById('recipientEmails');
            if (count === 0) {
                emailsDiv.innerHTML = '<p class="text-gray-500 italic">No users selected. Go to User List tab to select recipients.</p>';
            } else {
                const emailList = Array.from(selectedUserEmails).slice(0, 10).join(', ');
                emailsDiv.innerHTML = emailList + (count > 10 ? ` ... and ${count - 10} more` : '');
            }
        }

        // Email Functions
        async function sendEmails(event) {
            event.preventDefault();

            if (selectedUserEmails.size === 0) {
                alert('Please select at least one user to send email to');
                return;
            }

            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const includePersonalization = document.getElementById('includePersonalization').checked;

            const statusDiv = document.getElementById('emailStatus');
            statusDiv.innerHTML = '<div class="p-4 bg-blue-50 rounded"><p>Sending emails...</p><div class="mt-2 bg-gray-200 rounded h-2"><div id="progressBar" class="bg-blue-500 h-2 rounded transition-all duration-300" style="width: 0%"></div></div></div>';

            let sent = 0;
            let failed = 0;
            const total = selectedUserEmails.size;

            for (const email of selectedUserEmails) {
                const user = users.find(u => u.email === email);
                const personalizedMessage = includePersonalization && user 
                    ? message.replace(/{name}/g, user.name)
                    : message;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'sendEmail',
                            to: email,
                            name: user?.name || '',
                            subject: subject,
                            message: personalizedMessage
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        sent++;
                    } else {
                        failed++;
                        console.error(`Failed to send to ${email}:`, data.message);
                    }
                } catch (error) {
                    console.error(`Failed to send to ${email}:`, error);
                    failed++;
                }

                const progress = ((sent + failed) / total) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            }

            // Update sent count
            const currentSent = parseInt(localStorage.getItem('emailsSentToday') || 0);
            localStorage.setItem('emailsSentToday', currentSent + sent);
            updateStats();

            statusDiv.innerHTML = `
                <div class="p-4 ${sent > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded">
                    <p class="${sent > 0 ? 'text-green-800' : 'text-red-800'} font-semibold">
                        ${sent > 0 ? '‚úÖ Email campaign completed!' : '‚ùå Email campaign failed'}
                    </p>
                    <p class="text-sm mt-2">Successfully sent: ${sent} / ${total}</p>
                    ${failed > 0 ? `<p class="text-sm text-red-600">Failed: ${failed}</p>` : ''}
                </div>
            `;

            // Reset form if all sent successfully
            if (failed === 0) {
                setTimeout(() => {
                    document.getElementById('emailForm').reset();
                }, 3000);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-row:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Login Page -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h1>
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Admin Email" 
                    class="w-full p-3 border border-gray-300 rounded mb-4 focus:outline-none focus:border-blue-500">
                <button onclick="sendVerificationCode()" 
                    class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition">
                    Send Verification Code
                </button>
            </div>
            <div id="verificationForm" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Enter the 6-digit code sent to your email</p>
                <input type="text" id="verificationCode" placeholder="000000" maxlength="6"
                    class="w-full p-3 border border-gray-300 rounded mb-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500">
                <button onclick="verifyCode()" 
                    class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition">
                    Verify & Login
                </button>
                <button onclick="backToLogin()" 
                    class="w-full mt-2 text-sm text-gray-600 hover:text-gray-800">
                    ‚Üê Back to login
                </button>
            </div>
            <div id="loginMessage" class="mt-4 text-sm text-center"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center gap-4">
                    <span id="adminEmailDisplay" class="text-sm"></span>
                    <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white border-b">
            <div class="container mx-auto">
                <nav class="flex gap-4 p-4">
                    <button onclick="showTab('overview')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 font-semibold text-blue-600 bg-blue-50">
                        Overview
                    </button>
                    <button onclick="showTab('users')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        User List
                    </button>
                    <button onclick="showTab('email')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        Send Emails
                    </button>
                    <button onclick="showTab('settings')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100">
                        Settings
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto p-6">
            
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Total Users</h3>
                        <p id="totalUsers" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Selected Users</h3>
                        <p id="selectedUsers" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Emails Sent Today</h3>
                        <p id="emailsSent" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="showTab('users')" class="p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 transition text-left">
                            <h3 class="font-semibold text-blue-600 mb-1">üìã View Users</h3>
                            <p class="text-sm text-gray-600">View and manage user list from Google Sheets</p>
                        </button>
                        <button onclick="showTab('email')" class="p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 transition text-left">
                            <h3 class="font-semibold text-green-600 mb-1">‚úâÔ∏è Send Email</h3>
                            <p class="text-sm text-gray-600">Compose and send emails to selected users</p>
                        </button>
                        <button onclick="loadUsersFromSheets()" class="p-4 border-2 border-purple-500 rounded-lg hover:bg-purple-50 transition text-left">
                            <h3 class="font-semibold text-purple-600 mb-1">üîÑ Refresh Data</h3>
                            <p class="text-sm text-gray-600">Reload user data from Google Sheets</p>
                        </button>
                        <button onclick="showTab('settings')" class="p-4 border-2 border-orange-500 rounded-lg hover:bg-orange-50 transition text-left">
                            <h3 class="font-semibold text-orange-600 mb-1">‚öôÔ∏è Settings</h3>
                            <p class="text-sm text-gray-600">Configure API keys and integrations</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User List</h2>
                        <div class="flex gap-2">
                            <button onclick="selectAll()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Select All
                            </button>
                            <button onclick="deselectAll()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Deselect All
                            </button>
                            <button onclick="loadUsersFromSheets()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="searchUsers" placeholder="Search users..." 
                            onkeyup="filterUsers()"
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3 text-left">
                                        <input type="checkbox" id="selectAllCheckbox" onclick="selectAll()">
                                    </th>
                                    <th class="p-3 text-left">Name</th>
                                    <th class="p-3 text-left">Email</th>
                                    <th class="p-3 text-left">Phone</th>
                                    <th class="p-3 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <tr>
                                    <td colspan="5" class="p-8 text-center text-gray-500">
                                        No users loaded. Please configure Google Sheets API in Settings.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="userCount" class="mt-4 text-sm text-gray-600"></div>
                </div>
            </div>

            <!-- Email Tab -->
            <div id="emailTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Send Email to Selected Users</h2>
                    
                    <div id="selectedUsersList" class="mb-4 p-4 bg-blue-50 rounded">
                        <h3 class="font-semibold mb-2">Selected Recipients: <span id="recipientCount">0</span></h3>
                        <div id="recipientEmails" class="text-sm text-gray-700"></div>
                    </div>

                    <form id="emailForm" onsubmit="sendEmails(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Subject</label>
                            <input type="text" id="emailSubject" required
                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                placeholder="Enter email subject">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Message</label>
                            <textarea id="emailMessage" rows="10" required
                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                placeholder="Enter your message here..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="includePersonalization">
                                <span class="text-sm">Include personalization (use {name} in message)</span>
                            </label>
                        </div>

                        <button type="submit" 
                            class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition font-semibold">
                            üìß Send Email to <span id="sendCount">0</span> Recipients
                        </button>
                    </form>

                    <div id="emailStatus" class="mt-4"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-bold mb-4">Google Sheets Configuration</h2>
                    <p class="text-sm text-gray-600 mb-4">Configure your Google Sheets API to load user data</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Google Sheets API Key</label>
                        <input type="password" id="sheetsApiKey" 
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            placeholder="Enter your Google Sheets API key">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Spreadsheet ID</label>
                        <input type="text" id="spreadsheetId" 
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            placeholder="Enter your spreadsheet ID">
                        <p class="text-xs text-gray-500 mt-1">Found in the URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Sheet Name/Range</label>
                        <input type="text" id="sheetRange" value="Sheet1!A:D"
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            placeholder="e.g., Sheet1!A:D">
                    </div>

                    <button onclick="saveGoogleSheetsConfig()" 
                        class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition">
                        Save Configuration
                    </button>

                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                        <h4 class="font-semibold text-sm mb-2">üìù Setup Instructions:</h4>
                        <ol class="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                            <li>Go to <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a></li>
                            <li>Enable Google Sheets API</li>
                            <li>Create an API key</li>
                            <li>Make your spreadsheet publicly readable or use OAuth</li>
                            <li>Expected columns: Name, Email, Phone, Status</li>
                        </ol>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Email Service Configuration</h2>
                    <p class="text-sm text-gray-600 mb-4">Configure EmailJS to send emails</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">EmailJS Public Key</label>
                        <input type="text" id="emailjsPublicKey" 
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            placeholder="Enter your EmailJS public key">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Service ID</label>
                        <input type="text" id="emailjsServiceId" 
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            placeholder="Enter your service ID">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Template ID</label>
                        <input type="text" id="emailjsTemplateId" 
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            placeholder="Enter your template ID">
                    </div>

                    <button onclick="saveEmailConfig()" 
                        class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition">
                        Save Configuration
                    </button>

                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                        <h4 class="font-semibold text-sm mb-2">üìù Setup Instructions:</h4>
                        <ol class="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                            <li>Sign up at <a href="https://www.emailjs.com/" target="_blank" class="text-blue-600 hover:underline">EmailJS.com</a></li>
                            <li>Create an email service</li>
                            <li>Create an email template with variables: {name}, {email}, {subject}, {message}</li>
                            <li>Copy your Public Key, Service ID, and Template ID</li>
                        </ol>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration
        const ADMIN_EMAIL = 'thomaslancheros.ail@gmail.com';
        let users = [];
        let selectedUserEmails = new Set();
        let verificationCodeSent = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadSavedConfig();
        });

        // Authentication Functions
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('adminAuth') === 'true';
            const savedEmail = localStorage.getItem('adminEmail');
            
            if (isAuthenticated && savedEmail === ADMIN_EMAIL) {
                showDashboard();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('adminEmailDisplay').textContent = ADMIN_EMAIL;
            loadUsersFromSheets();
            updateStats();
        }

        async function sendVerificationCode() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showMessage('Please enter your email address', 'error');
                return;
            }

            if (email !== ADMIN_EMAIL) {
                showMessage('Unauthorized email address', 'error');
                return;
            }

            // Generate 6-digit code
            verificationCodeSent = Math.floor(100000 + Math.random() * 900000).toString();
            
            showMessage('Sending verification code...', 'info');

            // In production, send actual email here
            // For demo, we'll simulate sending and show the code
            setTimeout(() => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('verificationForm').classList.remove('hidden');
                showMessage(`Demo: Your code is ${verificationCodeSent}`, 'success');
                
                // In production, you would send the email like this:
                // sendEmailVerification(email, verificationCodeSent);
            }, 1000);
        }

        function verifyCode() {
            const enteredCode = document.getElementById('verificationCode').value.trim();
            
            if (enteredCode === verificationCodeSent) {
                localStorage.setItem('adminAuth', 'true');
                localStorage.setItem('adminEmail', ADMIN_EMAIL);
                showMessage('Login successful!', 'success');
                setTimeout(() => {
                    showDashboard();
                }, 1000);
            } else {
                showMessage('Invalid verification code', 'error');
            }
        }

        function backToLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('verificationForm').classList.add('hidden');
            document.getElementById('verificationCode').value = '';
            showMessage('', '');
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminEmail');
            showLogin();
            document.getElementById('loginEmail').value = '';
            document.getElementById('verificationCode').value = '';
            backToLogin();
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            messageDiv.className = `mt-4 text-sm text-center ${colors[type] || ''}`;
            messageDiv.textContent = message;
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active styling from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('font-semibold', 'text-blue-600', 'bg-blue-50');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active styling to clicked button
            event.target.classList.add('font-semibold', 'text-blue-600', 'bg-blue-50');
            
            if (tabName === 'email') {
                updateRecipientList();
            }
        }

        // Google Sheets Functions
        function loadSavedConfig() {
            const apiKey = localStorage.getItem('sheetsApiKey');
            const spreadsheetId = localStorage.getItem('spreadsheetId');
            const sheetRange = localStorage.getItem('sheetRange');
            const emailjsKey = localStorage.getItem('emailjsPublicKey');
            const serviceId = localStorage.getItem('emailjsServiceId');
            const templateId = localStorage.getItem('emailjsTemplateId');

            if (apiKey) document.getElementById('sheetsApiKey').value = apiKey;
            if (spreadsheetId) document.getElementById('spreadsheetId').value = spreadsheetId;
            if (sheetRange) document.getElementById('sheetRange').value = sheetRange;
            if (emailjsKey) document.getElementById('emailjsPublicKey').value = emailjsKey;
            if (serviceId) document.getElementById('emailjsServiceId').value = serviceId;
            if (templateId) document.getElementById('emailjsTemplateId').value = templateId;
        }

        function saveGoogleSheetsConfig() {
            const apiKey = document.getElementById('sheetsApiKey').value;
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const sheetRange = document.getElementById('sheetRange').value;

            localStorage.setItem('sheetsApiKey', apiKey);
            localStorage.setItem('spreadsheetId', spreadsheetId);
            localStorage.setItem('sheetRange', sheetRange);

            alert('Google Sheets configuration saved!');
            loadUsersFromSheets();
        }

        function saveEmailConfig() {
            const publicKey = document.getElementById('emailjsPublicKey').value;
            const serviceId = document.getElementById('emailjsServiceId').value;
            const templateId = document.getElementById('emailjsTemplateId').value;

            localStorage.setItem('emailjsPublicKey', publicKey);
            localStorage.setItem('emailjsServiceId', serviceId);
            localStorage.setItem('emailjsTemplateId', templateId);

            if (publicKey) {
                emailjs.init(publicKey);
            }

            alert('Email configuration saved!');
        }

        async function loadUsersFromSheets() {
            const apiKey = localStorage.getItem('sheetsApiKey');
            const spreadsheetId = localStorage.getItem('spreadsheetId');
            const sheetRange = localStorage.getItem('sheetRange') || 'Sheet1!A:D';

            if (!apiKey || !spreadsheetId) {
                alert('Please configure Google Sheets API in Settings first');
                return;
            }

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetRange}?key=${apiKey}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.values && data.values.length > 1) {
                    // Skip header row
                    const rows = data.values.slice(1);
                    users = rows.map(row => ({
                        name: row[0] || '',
                        email: row[1] || '',
                        phone: row[2] || '',
                        status: row[3] || 'Active'
                    })).filter(user => user.email); // Only include users with email

                    displayUsers();
                    updateStats();
                } else {
                    alert('No data found in the spreadsheet');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users from Google Sheets. Please check your configuration.');
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = 'user-row border-b';
                row.innerHTML = `
                    <td class="p-3">
                        <input type="checkbox" class="user-checkbox" data-email="${user.email}" 
                            onchange="toggleUserSelection('${user.email}')">
                    </td>
                    <td class="p-3">${user.name}</td>
                    <td class="p-3">${user.email}</td>
                    <td class="p-3">${user.phone}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('userCount').textContent = `Showing ${users.length} users`;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function selectAll() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                selectedUserEmails.add(checkbox.dataset.email);
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateStats();
            updateRecipientList();
        }

        function deselectAll() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            selectedUserEmails.clear();
            updateStats();
            updateRecipientList();
        }

        function toggleUserSelection(email) {
            if (selectedUserEmails.has(email)) {
                selectedUserEmails.delete(email);
            } else {
                selectedUserEmails.add(email);
            }
            updateStats();
            updateRecipientList();
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('selectedUsers').textContent = selectedUserEmails.size;
            
            const emailsSent = localStorage.getItem('emailsSentToday') || 0;
            document.getElementById('emailsSent').textContent = emailsSent;
        }

        function updateRecipientList() {
            const count = selectedUserEmails.size;
            document.getElementById('recipientCount').textContent = count;
            document.getElementById('sendCount').textContent = count;
            
            const emailsDiv = document.getElementById('recipientEmails');
            if (count === 0) {
                emailsDiv.innerHTML = '<p class="text-gray-500 italic">No users selected. Go to User List tab to select recipients.</p>';
            } else {
                const emailList = Array.from(selectedUserEmails).slice(0, 10).join(', ');
                emailsDiv.innerHTML = emailList + (count > 10 ? ` ... and ${count - 10} more` : '');
            }
        }

        // Email Functions
        async function sendEmails(event) {
            event.preventDefault();

            if (selectedUserEmails.size === 0) {
                alert('Please select at least one user to send email to');
                return;
            }

            const publicKey = localStorage.getItem('emailjsPublicKey');
            const serviceId = localStorage.getItem('emailjsServiceId');
            const templateId = localStorage.getItem('emailjsTemplateId');

            if (!publicKey || !serviceId || !templateId) {
                alert('Please configure EmailJS in Settings first');
                showTab('settings');
                return;
            }

            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const includePersonalization = document.getElementById('includePersonalization').checked;

            const statusDiv = document.getElementById('emailStatus');
            statusDiv.innerHTML = '<div class="p-4 bg-blue-50 rounded"><p>Sending emails...</p><div class="mt-2 bg-gray-200 rounded h-2"><div id="progressBar" class="bg-blue-500 h-2 rounded transition-all duration-300" style="width: 0%"></div></div></div>';

            let sent = 0;
            let failed = 0;

            for (const email of selectedUserEmails) {
                const user = users.find(u => u.email === email);
                const personalizedMessage = includePersonalization && user 
                    ? message.replace(/{name}/g, user.name)
                    : message;

                try {
                    // In production, send actual emails here
                    // await emailjs.send(serviceId, templateId, {
                    //     to_email: email,
                    //     to_name: user.name,
                    //     subject: subject,
                    //     message: personalizedMessage
                    // });
                    
                    // Simulate sending for demo
                    await new Promise(resolve => setTimeout(resolve, 100));
                    sent++;
                } catch (error) {
                    console.error(`Failed to send to ${email}:`, error);
                    failed++;
                }

                const progress = ((sent + failed) / selectedUserEmails.size) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            }

            // Update sent count
            const currentSent = parseInt(localStorage.getItem('emailsSentToday') || 0);
            localStorage.setItem('emailsSentToday', currentSent + sent);
            updateStats();

            statusDiv.innerHTML = `
                <div class="p-4 bg-green-50 border border-green-200 rounded">
                    <p class="text-green-800 font-semibold">‚úÖ Email campaign completed!</p>
                    <p class="text-sm mt-2">Successfully sent: ${sent}</p>
                    ${failed > 0 ? `<p class="text-sm text-red-600">Failed: ${failed}</p>` : ''}
                </div>
            `;

            // Reset form
            document.getElementById('emailForm').reset();
        }
    </script>
</body>
</html>

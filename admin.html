<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-row:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Login Page -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h1>
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="Admin Email" 
                    class="w-full p-3 border border-gray-300 rounded mb-4 focus:outline-none focus:border-blue-500">
                <button onclick="sendVerificationCode()" 
                    class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition">
                    Send Verification Code
                </button>
            </div>
            <div id="verificationForm" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Enter the 6-digit code sent to your email</p>
                <input type="text" id="verificationCode" placeholder="000000" maxlength="6"
                    class="w-full p-3 border border-gray-300 rounded mb-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500">
                <button onclick="verifyCode()" 
                    class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition">
                    Verify & Login
                </button>
                <button onclick="backToLogin()" 
                    class="w-full mt-2 text-sm text-gray-600 hover:text-gray-800">
                    ‚Üê Back to login
                </button>
            </div>
            <div id="loginMessage" class="mt-4 text-sm text-center"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center gap-4">
                    <span id="adminEmailDisplay" class="text-sm"></span>
                    <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white border-b">
            <div class="container mx-auto">
                <nav class="flex gap-4 p-4 overflow-x-auto">
                    <button onclick="showTab('overview')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 font-semibold text-blue-600 bg-blue-50 whitespace-nowrap">
                        Overview
                    </button>
                    <button onclick="showTab('users')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 whitespace-nowrap">
                        User List
                    </button>
                    <button onclick="showTab('recruiters')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 whitespace-nowrap">
                        üë• Recruiters
                    </button>
                    <button onclick="showTab('email')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 whitespace-nowrap">
                        Send Emails
                    </button>
                    <button onclick="showTab('sms')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 whitespace-nowrap">
                        Send SMS
                    </button>
                    <button onclick="showTab('settings')" class="tab-btn px-4 py-2 rounded hover:bg-gray-100 whitespace-nowrap">
                        Settings
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto p-6">
            
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Total Users</h3>
                        <p id="totalUsers" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Total Recruiters</h3>
                        <p id="totalRecruiters" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Selected Users</h3>
                        <p id="selectedUsers" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm font-semibold mb-2">Emails Sent Today</h3>
                        <p id="emailsSent" class="text-3xl font-bold text-orange-600">0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="showTab('users')" class="p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 transition text-left">
                            <h3 class="font-semibold text-blue-600 mb-1">üìã View Users</h3>
                            <p class="text-sm text-gray-600">View and manage user list from Google Sheets</p>
                        </button>
                        <button onclick="showTab('recruiters')" class="p-4 border-2 border-purple-500 rounded-lg hover:bg-purple-50 transition text-left">
                            <h3 class="font-semibold text-purple-600 mb-1">üë• Manage Recruiters</h3>
                            <p class="text-sm text-gray-600">Promote users to recruiter status</p>
                        </button>
                        <button onclick="showTab('email')" class="p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 transition text-left">
                            <h3 class="font-semibold text-green-600 mb-1">‚úâÔ∏è Send Email</h3>
                            <p class="text-sm text-gray-600">Compose and send emails to selected users</p>
                        </button>
                        <button onclick="loadUsersFromSheets()" class="p-4 border-2 border-orange-500 rounded-lg hover:bg-orange-50 transition text-left">
                            <h3 class="font-semibold text-orange-600 mb-1">üîÑ Refresh Data</h3>
                            <p class="text-sm text-gray-600">Reload user data from Google Sheets</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">User List</h2>
                        <div class="flex gap-2">
                            <button onclick="selectAll()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Select All
                            </button>
                            <button onclick="deselectAll()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Deselect All
                            </button>
                            <button onclick="loadUsersFromSheets()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="searchUsers" placeholder="Search users..." 
                            onkeyup="filterUsers()"
                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3 text-left">
                                        <input type="checkbox" id="selectAllCheckbox" onclick="selectAll()">
                                    </th>
                                    <th class="p-3 text-left">Name</th>
                                    <th class="p-3 text-left">Email</th>
                                    <th class="p-3 text-left">Phone</th>
                                    <th class="p-3 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <tr>
                                    <td colspan="5" class="p-8 text-center text-gray-500">
                                        No users loaded. Click "Refresh" to load users.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="userCount" class="mt-4 text-sm text-gray-600"></div>
                </div>
            </div>

            <!-- RECRUITERS TAB -->
            <div id="recruitersTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-2xl font-bold mb-6">Recruiter Management</h2>
                    
                    <!-- Promote to Recruiter Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4 text-blue-800">‚ú® Promote User to Recruiter</h3>
                        <p class="text-sm text-gray-700 mb-4">
                            Enter the user's full name (lowercase). A new Google Sheets tab will be created with their name,
                            and they'll get a unique referral URL.
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Full Name *</label>
                                <input type="text" id="recruiterFullName" 
                                       placeholder="thomas lancheros"
                                       class="w-full border-2 border-gray-300 rounded px-3 py-2 focus:border-blue-500 focus:outline-none">
                                <p class="text-xs text-gray-500 mt-1">Use lowercase (e.g., "thomas lancheros")</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">User Email (optional)</label>
                                <input type="email" id="recruiterEmail" 
                                       placeholder="thomas@example.com"
                                       class="w-full border-2 border-gray-300 rounded px-3 py-2 focus:border-blue-500 focus:outline-none">
                                <p class="text-xs text-gray-500 mt-1">For your reference</p>
                            </div>
                            
                            <div class="flex items-end">
                                <button onclick="promoteToRecruiter()" 
                                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition">
                                    ‚úì Create Recruiter
                                </button>
                            </div>
                        </div>
                        
                        <div id="promotionResult" class="hidden mt-4"></div>
                    </div>
                    
                    <!-- Current Recruiters List -->
                    <div class="bg-white rounded-lg border-2 border-gray-200">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">Current Recruiters</h3>
                            <button onclick="loadRecruiters()" class="text-sm text-blue-600 hover:underline font-semibold">
                                üîÑ Refresh
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tab Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Leads</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Referral URL</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recruitersTableBody">
                                    <tr>
                                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                            Click "Refresh" to load recruiters
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Tab -->
            <div id="emailTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Send Email to Selected Users</h2>
                    
                    <div id="selectedUsersList" class="mb-4 p-4 bg-blue-50 rounded">
                        <h3 class="font-semibold mb-2">Selected Recipients: <span id="recipientCount">0</span></h3>
                        <div id="recipientEmails" class="text-sm text-gray-700"></div>
                    </div>

                    <form id="emailForm" onsubmit="sendEmails(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Subject</label>
                            <input type="text" id="emailSubject" required
                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                placeholder="Enter email subject">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Message</label>
                            <textarea id="emailMessage" rows="10" required
                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                placeholder="Enter your message here..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="includePersonalization">
                                <span class="text-sm">Include personalization (use {name} in message)</span>
                            </label>
                        </div>

                        <button type="submit" 
                            class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition font-semibold">
                            üìß Send Email to <span id="sendCount">0</span> Recipients
                        </button>
                    </form>

                    <div id="emailStatus" class="mt-4"></div>
                </div>
            </div>

            <!-- SMS Tab -->
            <div id="smsTab" class="tab-content">
              <h2 style="margin-top: 0;">üì± Send SMS Messages</h2>
              
              <div style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">üöÄ Queue-Based SMS System</div>
                <div style="color: #1e3a8a; font-size: 14px; line-height: 1.6;">
                  1. Select recipients and write your message<br>
                  2. Click "Queue Messages" to add jobs to the queue<br>
                  3. <a href="https://voice.google.com" target="_blank" style="color: #2563eb; font-weight: 600;">Open Google Voice in new tab ‚Üí</a><br>
                  4. Tampermonkey will automatically detect and send pending messages
                </div>
              </div>
            
              <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px;">
                  üìã Select Recipients (with phone numbers only)
                </label>
                
                <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                  <button onclick="selectAllSMS()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Select All
                  </button>
                  <button onclick="deselectAllSMS()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Deselect All
                  </button>
                  <span id="smsSelectedCount" style="padding: 8px 16px; background: #f3f4f6; border-radius: 6px; font-weight: 600;">
                    0 selected
                  </span>
                </div>
            
                <div id="smsRecipientsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: white;">
                  <div style="color: #6b7280; text-align: center; padding: 20px;">
                    Load users first
                  </div>
                </div>
              </div>
            
              <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px;">
                  ‚úçÔ∏è Message Template
                </label>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                  Use {name}, {email}, {phone} for personalization
                </div>
                <textarea 
                  id="smsMessageTemplate" 
                  placeholder="Hi {name}, this is a message from Closing Coalition..."
                  style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; resize: vertical;"
                ></textarea>
                <div style="font-size: 13px; color: #6b7280; margin-top: 6px;">
                  Character count: <span id="smsCharCount">0</span>/160
                </div>
              </div>
            
              <div id="smsQueueStatus" style="display: none; background: #f0fdf4; border: 1px solid #86efac; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #16a34a; margin-bottom: 8px;">
                  ‚úÖ Messages Queued Successfully!
                </div>
                <div id="smsQueueStatusText" style="color: #15803d; font-size: 14px;"></div>
              </div>
            
              <div id="smsError" style="display: none; background: #fef2f2; border: 1px solid #fca5a5; padding: 16px; border-radius: 8px; margin-bottom: 20px; color: #991b1b;">
              </div>
            
              <div>
                <button 
                  id="queueSMSBtn" 
                  onclick="queueSMSMessages()"
                  style="padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);"
                >
                  üì§ Queue Messages
                </button>
                
                <a 
                  href="https://voice.google.com" 
                  target="_blank"
                  style="margin-left: 12px; padding: 14px 28px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-weight: 700; font-size: 16px; text-decoration: none; display: inline-block;"
                >
                  üåê Open Google Voice ‚Üí
                </a>
              </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-bold mb-4">API Configuration</h2>
                    
                    <div class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded">
                        <h3 class="font-semibold mb-2 text-yellow-800">‚ö†Ô∏è UPDATE RECRUITING API URL</h3>
                        <p class="text-sm text-yellow-700 mb-2">Search for: <code class="bg-white px-2 py-1 rounded">PASTE_YOUR_RECRUITING_APPS_SCRIPT_URL_HERE</code></p>
                        <p class="text-xs text-yellow-600">Press Ctrl+F (or Cmd+F) and paste your deployed Google Apps Script URL</p>
                    </div>

                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
                        <h3 class="font-semibold mb-2">‚úÖ Connected Services</h3>
                        <div class="text-sm space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">‚óè</span>
                                <span>Cloudflare Worker API</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">‚óè</span>
                                <span>Google Apps Script Backend</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-green-600">‚óè</span>
                                <span>Google Sheets Database</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded">
                        <h3 class="font-semibold mb-2">API Endpoint</h3>
                        <code class="text-sm bg-white px-3 py-2 rounded border block break-all">
                            https://closing-coalition-api.thomaslancheros06.workers.dev/
                        </code>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded">
                        <h3 class="font-semibold mb-2">Google Sheets</h3>
                        <code class="text-sm bg-white px-3 py-2 rounded border block break-all">
                            https://script.google.com/macros/s/AKfycbzyOmxYVDoYJ6zmBMslbneUavlEKeWwplzA8zH8CvkXUx6sOTnfC7JPEsoTbjfJ2scvBQ/exec
                        </code>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">System Actions</h2>
                    
                    <div class="space-y-3">
                        <button onclick="resetEmailCount()" 
                            class="w-full p-4 border-2 border-orange-500 rounded-lg hover:bg-orange-50 transition text-left">
                            <h3 class="font-semibold text-orange-600 mb-1">üîÑ Reset Email Counter</h3>
                            <p class="text-sm text-gray-600">Reset today's sent email count to 0</p>
                        </button>

                        <button onclick="clearCache()" 
                            class="w-full p-4 border-2 border-red-500 rounded-lg hover:bg-red-50 transition text-left">
                            <h3 class="font-semibold text-red-600 mb-1">üóëÔ∏è Clear Cache</h3>
                            <p class="text-sm text-gray-600">Clear all cached data and statistics</p>
                        </button>

                        <button onclick="loadUsersFromSheets()" 
                            class="w-full p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 transition text-left">
                            <h3 class="font-semibold text-green-600 mb-1">üì• Reload Users</h3>
                            <p class="text-sm text-gray-600">Fetch latest user data from Google Sheets</p>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CONFIGURATION - UPDATE THESE URLS ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ============================================================
        
        // Main API (Cloudflare Worker)
        const API_URL = 'https://closing-coalition-api.thomaslancheros06.workers.dev/';
        
        // ‚ö†Ô∏è UPDATE THIS - Recruiting API (Google Apps Script)
        // Deploy recruiting-script.gs and paste URL here:
        const RECRUITING_API_URL = 'https://script.google.com/macros/s/AKfycbwd2h_vdsWbr4tZfnNBkDoGK0pGKri2_DybQ9dFwvguGORcBN9-sQ1EhyIufos1CIAy/exec';
        
        const ADMIN_EMAIL = 'thomaslancheros.ail@gmail.com';
        
        // ============================================================
        // GLOBAL VARIABLES
        // ============================================================
        let users = [];
        let recruiters = [];
        let selectedUserEmails = new Set();

        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // ============================================================
        // AUTHENTICATION
        // ============================================================
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('adminAuth') === 'true';
            const savedEmail = localStorage.getItem('adminEmail');
            
            if (isAuthenticated && savedEmail === ADMIN_EMAIL) {
                showDashboard();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('adminEmailDisplay').textContent = ADMIN_EMAIL;
            loadUsersFromSheets();
            updateStats();
        }

        async function sendVerificationCode() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showMessage('Please enter your email address', 'error');
                return;
            }

            if (email !== ADMIN_EMAIL) {
                showMessage('Unauthorized email address', 'error');
                return;
            }
            
            showMessage('Sending verification code...', 'info');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'sendVerification',
                        email: email
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('verificationForm').classList.remove('hidden');
                    showMessage('Verification code sent to your email!', 'success');
                } else {
                    showMessage(data.message || 'Failed to send verification code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error sending verification code. Please try again.', 'error');
            }
        }

        async function verifyCode() {
            const enteredCode = document.getElementById('verificationCode').value.trim();
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!enteredCode) {
                showMessage('Please enter the verification code', 'error');
                return;
            }

            showMessage('Verifying...', 'info');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verifyCode',
                        email: email,
                        code: enteredCode
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('adminAuth', 'true');
                    localStorage.setItem('adminEmail', ADMIN_EMAIL);
                    showMessage('Login successful!', 'success');
                    setTimeout(() => {
                        showDashboard();
                    }, 1000);
                } else {
                    showMessage(data.message || 'Invalid verification code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error verifying code. Please try again.', 'error');
            }
        }

        function backToLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('verificationForm').classList.add('hidden');
            document.getElementById('verificationCode').value = '';
            showMessage('', '');
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminEmail');
            showLogin();
            document.getElementById('loginEmail').value = '';
            document.getElementById('verificationCode').value = '';
            backToLogin();
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            messageDiv.className = `mt-4 text-sm text-center ${colors[type] || ''}`;
            messageDiv.textContent = message;
        }

        // ============================================================
        // TAB NAVIGATION
        // ============================================================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('font-semibold', 'text-blue-600', 'bg-blue-50');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            event.target.classList.add('font-semibold', 'text-blue-600', 'bg-blue-50');
            
            if (tabName === 'email') {
                updateRecipientList();
            }
            
            if (tabName === 'recruiters') {
                loadRecruiters();
            }
        }

        // ============================================================
        // CONFIGURATION
        // ============================================================
        function clearCache() {
            if (confirm('Are you sure you want to clear all cached data?')) {
                localStorage.removeItem('emailsSentToday');
                updateStats();
                alert('Cache cleared successfully!');
            }
        }

        function resetEmailCount() {
            if (confirm('Reset today\'s email count to 0?')) {
                localStorage.setItem('emailsSentToday', '0');
                updateStats();
                alert('Email count reset!');
            }
        }

        // ============================================================
        // USER MANAGEMENT
        // ============================================================
        async function loadUsersFromSheets() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getUsers'
                    })
                });

                const data = await response.json();

                if (data.success && data.users) {
                    users = data.users.filter(user => user.email);
                    displayUsers();
                    updateStats();
                    populateSMSRecipients(data.users);
                    console.log(`Loaded ${users.length} users from Google Sheets`);
                } else {
                    console.error('Error loading users:', data.message);
                    alert('Error loading users: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users from Google Sheets. Please check your connection.');
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            users.forEach((user) => {
                const row = document.createElement('tr');
                row.className = 'user-row border-b';
                row.innerHTML = `
                    <td class="p-3">
                        <input type="checkbox" class="user-checkbox" data-email="${user.email}" 
                            onchange="toggleUserSelection('${user.email}')">
                    </td>
                    <td class="p-3">${user.name}</td>
                    <td class="p-3">${user.email}</td>
                    <td class="p-3">${user.phone || 'N/A'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('userCount').textContent = `Showing ${users.length} users`;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function selectAll() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                selectedUserEmails.add(checkbox.dataset.email);
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateStats();
            updateRecipientList();
        }

        function deselectAll() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            selectedUserEmails.clear();
            updateStats();
            updateRecipientList();
        }

        function toggleUserSelection(email) {
            if (selectedUserEmails.has(email)) {
                selectedUserEmails.delete(email);
            } else {
                selectedUserEmails.add(email);
            }
            updateStats();
            updateRecipientList();
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('selectedUsers').textContent = selectedUserEmails.size;
            document.getElementById('totalRecruiters').textContent = recruiters.length;
            
            const emailsSent = localStorage.getItem('emailsSentToday') || 0;
            document.getElementById('emailsSent').textContent = emailsSent;
        }

        function updateRecipientList() {
            const count = selectedUserEmails.size;
            document.getElementById('recipientCount').textContent = count;
            document.getElementById('sendCount').textContent = count;
            
            const emailsDiv = document.getElementById('recipientEmails');
            if (count === 0) {
                emailsDiv.innerHTML = '<p class="text-gray-500 italic">No users selected. Go to User List tab to select recipients.</p>';
            } else {
                const emailList = Array.from(selectedUserEmails).slice(0, 10).join(', ');
                emailsDiv.innerHTML = emailList + (count > 10 ? ` ... and ${count - 10} more` : '');
            }
        }

        // ============================================================
        // EMAIL FUNCTIONS
        // ============================================================
        async function sendEmails(event) {
            event.preventDefault();

            if (selectedUserEmails.size === 0) {
                alert('Please select at least one user to send email to');
                return;
            }

            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const includePersonalization = document.getElementById('includePersonalization').checked;

            const statusDiv = document.getElementById('emailStatus');
            statusDiv.innerHTML = '<div class="p-4 bg-blue-50 rounded"><p>Sending emails...</p><div class="mt-2 bg-gray-200 rounded h-2"><div id="progressBar" class="bg-blue-500 h-2 rounded transition-all duration-300" style="width: 0%"></div></div></div>';

            let sent = 0;
            let failed = 0;
            const total = selectedUserEmails.size;

            for (const email of selectedUserEmails) {
                const user = users.find(u => u.email === email);
                const personalizedMessage = includePersonalization && user 
                    ? message.replace(/{name}/g, user.name)
                    : message;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'sendEmail',
                            to: email,
                            name: user?.name || '',
                            subject: subject,
                            message: personalizedMessage
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        sent++;
                    } else {
                        failed++;
                        console.error(`Failed to send to ${email}:`, data.message);
                    }
                } catch (error) {
                    console.error(`Failed to send to ${email}:`, error);
                    failed++;
                }

                const progress = ((sent + failed) / total) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            }

            const currentSent = parseInt(localStorage.getItem('emailsSentToday') || 0);
            localStorage.setItem('emailsSentToday', currentSent + sent);
            updateStats();

            statusDiv.innerHTML = `
                <div class="p-4 ${sent > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded">
                    <p class="${sent > 0 ? 'text-green-800' : 'text-red-800'} font-semibold">
                        ${sent > 0 ? '‚úÖ Email campaign completed!' : '‚ùå Email campaign failed'}
                    </p>
                    <p class="text-sm mt-2">Successfully sent: ${sent} / ${total}</p>
                    ${failed > 0 ? `<p class="text-sm text-red-600">Failed: ${failed}</p>` : ''}
                </div>
            `;

            if (failed === 0) {
                setTimeout(() => {
                    document.getElementById('emailForm').reset();
                }, 3000);
            }
        }

        // ============================================================
        // SMS FUNCTIONS
        // ============================================================
        const smsTemplate = document.getElementById('smsMessageTemplate');
        if (smsTemplate) {
            smsTemplate.addEventListener('input', (e) => {
                const charCount = e.target.value.length;
                const charCountEl = document.getElementById('smsCharCount');
                if (charCountEl) {
                    charCountEl.textContent = charCount;
                }
            });
        }

        function populateSMSRecipients(users) {
            const listDiv = document.getElementById('smsRecipientsList');
            if (!listDiv) return;

            const usersWithPhone = users.filter(u => u.phone && u.phone.trim().length >= 10);

            if (usersWithPhone.length === 0) {
                listDiv.innerHTML = `
                    <div style="color: #dc2626; text-align: center; padding: 20px;">
                        ‚ö†Ô∏è No users have phone numbers yet.
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = usersWithPhone.map(user => `
                <label style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 6px; margin-bottom: 4px;" 
                       onmouseover="this.style.background='#f9fafb'" 
                       onmouseout="this.style.background='white'">
                    <input 
                        type="checkbox" 
                        class="sms-recipient-checkbox" 
                        value="${user.email}"
                        data-name="${user.name}"
                        data-phone="${user.phone}"
                        style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;"
                        onchange="updateSMSSelectedCount()"
                    />
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111827;">${user.name}</div>
                        <div style="font-size: 13px; color: #6b7280;">üìß ${user.email}</div>
                        <div style="font-size: 13px; color: #6b7280;">üì± ${user.phone}</div>
                    </div>
                </label>
            `).join('');

            updateSMSSelectedCount();
        }

        function selectAllSMS() {
            document.querySelectorAll('.sms-recipient-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateSMSSelectedCount();
        }

        function deselectAllSMS() {
            document.querySelectorAll('.sms-recipient-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateSMSSelectedCount();
        }

        function updateSMSSelectedCount() {
            const checked = document.querySelectorAll('.sms-recipient-checkbox:checked').length;
            const countEl = document.getElementById('smsSelectedCount');
            if (countEl) {
                countEl.textContent = `${checked} selected`;
            }
        }

        async function queueSMSMessages() {
            const messageTemplate = document.getElementById('smsMessageTemplate').value.trim();
            const selectedCheckboxes = document.querySelectorAll('.sms-recipient-checkbox:checked');

            document.getElementById('smsQueueStatus').style.display = 'none';
            document.getElementById('smsError').style.display = 'none';

            if (selectedCheckboxes.length === 0) {
                showSMSError('Please select at least one recipient');
                return;
            }

            if (!messageTemplate) {
                showSMSError('Please enter a message template');
                return;
            }

            const jobs = [];
            selectedCheckboxes.forEach(checkbox => {
                const name = checkbox.dataset.name;
                const email = checkbox.value;
                const phone = checkbox.dataset.phone;

                let personalizedMessage = messageTemplate
                    .replace(/\{name\}/g, name)
                    .replace(/\{email\}/g, email)
                    .replace(/\{phone\}/g, phone);

                jobs.push({
                    phone: phone,
                    name: name,
                    message: personalizedMessage
                });
            });

            const btn = document.getElementById('queueSMSBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Queueing...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'createSMSJob',
                        jobs: jobs
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('smsQueueStatus').style.display = 'block';
                    document.getElementById('smsQueueStatusText').textContent = 
                        `Queued ${data.created} message(s). Open Google Voice in a new tab to process them.`;
                    
                    deselectAllSMS();
                    document.getElementById('smsMessageTemplate').value = '';
                    document.getElementById('smsCharCount').textContent = '0';
                } else {
                    showSMSError(data.message || 'Failed to queue messages');
                }

            } catch (error) {
                console.error('Queue error:', error);
                showSMSError('Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showSMSError(message) {
            const errorDiv = document.getElementById('smsError');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
        }

        // ============================================================
        // RECRUITER MANAGEMENT
        // ============================================================
        async function promoteToRecruiter() {
            const fullName = document.getElementById('recruiterFullName').value.trim();
            const email = document.getElementById('recruiterEmail').value.trim();
            
            if (!fullName) {
                alert('Please enter the full name');
                return;
            }

            if (RECRUITING_API_URL === 'PASTE_YOUR_RECRUITING_APPS_SCRIPT_URL_HERE') {
                alert('‚ö†Ô∏è Recruiting API not configured!\n\nPlease update RECRUITING_API_URL in this file.\nSearch for: PASTE_YOUR_RECRUITING');
                return;
            }
            
            if (!confirm(`Create recruiter account for: "${fullName}"?\n\nThis will:\n‚Ä¢ Create a new Google Sheets tab\n‚Ä¢ Generate a referral URL\n‚Ä¢ Allow them to access the pipeline`)) {
                return;
            }
            
            const resultDiv = document.getElementById('promotionResult');
            resultDiv.innerHTML = '<div class="text-blue-600 font-semibold">Creating recruiter account...</div>';
            resultDiv.classList.remove('hidden');
            
            try {
                const response = await fetch(RECRUITING_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'promoteToRecruiter',
                        fullName: fullName,
                        email: email
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border-2 border-green-500 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">‚úÖ</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-green-800 mb-2">Recruiter Created Successfully!</h4>
                                    <div class="space-y-2 text-sm text-green-700">
                                        <p><strong>Name:</strong> ${result.fullName}</p>
                                        <p><strong>Tab Created:</strong> ${result.tabName}</p>
                                        <p><strong>Referral URL:</strong></p>
                                        <div class="bg-white p-2 rounded border border-green-300 font-mono text-xs break-all">
                                            ${result.recruiterUrl}
                                        </div>
                                    </div>
                                    <button onclick="copyText('${result.recruiterUrl}')" class="mt-3 bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">
                                        üìã Copy Referral URL
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('recruiterFullName').value = '';
                    document.getElementById('recruiterEmail').value = '';
                    await loadRecruiters();
                    
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">‚ö†Ô∏è</div>
                                <div>
                                    <h4 class="font-bold text-red-800 mb-1">Error</h4>
                                    <p class="text-red-700 text-sm">${result.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error promoting recruiter:', error);
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4">
                        <div class="flex items-start">
                            <div class="text-2xl mr-3">‚ö†Ô∏è</div>
                            <div>
                                <h4 class="font-bold text-red-800 mb-1">Network Error</h4>
                                <p class="text-red-700 text-sm">Could not connect. Check RECRUITING_API_URL.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function loadRecruiters() {
            if (RECRUITING_API_URL === 'PASTE_YOUR_RECRUITING_APPS_SCRIPT_URL_HERE') {
                const tbody = document.getElementById('recruitersTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-yellow-600">‚ö†Ô∏è Update RECRUITING_API_URL first</td></tr>';
                return;
            }

            const tbody = document.getElementById('recruitersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Loading...</td></tr>';
            
            try {
                const response = await fetch(RECRUITING_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getAllRecruiters'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.recruiters.length > 0) {
                    recruiters = result.recruiters;
                    tbody.innerHTML = result.recruiters.map(recruiter => `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-800">${capitalizeWords(recruiter.fullName)}</div>
                            </td>
                            <td class="px-6 py-4">
                                <code class="bg-gray-100 px-2 py-1 rounded text-sm">${recruiter.tabName}</code>
                            </td>
                            <td class="px-6 py-4">
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-semibold">
                                    ${recruiter.leadCount} leads
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <code class="text-xs text-gray-600 truncate max-w-xs">${recruiter.referralUrl}</code>
                                    <button onclick="copyText('${recruiter.referralUrl}')" 
                                            class="text-blue-600 hover:text-blue-800 text-xs">
                                        üìã
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <button onclick="alert('Open Google Sheets and find tab: ${recruiter.tabName}')" 
                                        class="text-sm text-blue-600 hover:underline">
                                    View Sheet
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    updateStats();
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No recruiters found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading recruiters:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error loading. Check RECRUITING_API_URL.</td></tr>';
            }
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Copied to clipboard:\n\n' + text);
            }).catch(err => {
                console.error('Error copying:', err);
                prompt('Copy this URL:', text);
            });
        }

        function capitalizeWords(str) {
            return str.replace(/\b\w/g, l => l.toUpperCase());
        }
    </script>
</body>
</html>

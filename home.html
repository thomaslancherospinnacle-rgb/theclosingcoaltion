<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Closing Coalition ‚Äî Home</title>
  <style>
    :root{
      --bg1:#071423;
      --bg2:#0a1a2b;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.72);
      --muted2: rgba(234,242,255,.52);
      --accent:#4fd1c5;
      --accent2:#2dd4bf;
      --danger:#ff5a7a;
      --ok:#22c55e;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(79,209,197,.22), transparent 55%),
        radial-gradient(1200px 700px at 80% 15%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 80%, rgba(99,102,241,.16), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100%;
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.18));
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 220px;
    }
    .dot{
      width:38px; height:38px;
      border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.06) 42%, rgba(79,209,197,.22) 100%),
                  linear-gradient(180deg, rgba(79,209,197,.55), rgba(45,212,191,.12));
      border:1px solid rgba(255,255,255,.14);
    }
    .title{font-weight:900; letter-spacing:.2px; line-height:1.05}
    .sub{font-size:12px; color:var(--muted2); margin-top:2px}

    .nav{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .nav a, .nav button{
      text-decoration:none;
      color: var(--text);
      font-weight:900;
      letter-spacing:.2px;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .05s ease, filter .15s ease, border-color .15s ease;
    }
    .nav a.primary{
      background: linear-gradient(180deg, rgba(79,209,197,.35), rgba(0,0,0,.18));
      border-color: rgba(79,209,197,.30);
    }
    .nav a:hover, .nav button:hover{filter:brightness(1.06)}
    .nav a:active, .nav button:active{transform: translateY(1px)}
    .pill{
      font-family: var(--mono);
      font-size:12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      max-width: 320px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Page */
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 40px;
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    .card{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .card h2{margin:0; font-size:16px; font-weight:900}
    .card .body{padding:16px}
    .muted{color:var(--muted); font-size:13px; line-height:1.55}
    
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width: 560px){
      .grid{grid-template-columns: 1fr 1fr;}
    }
    
    .grid3{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:12px;
    }
    
    .tile{
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .tile .k{font-weight:900; font-size:12px; color:var(--muted2); text-transform: uppercase; letter-spacing:.5px}
    .tile .v{font-family:var(--mono); font-size:20px; font-weight:900; color:var(--text)}
    .tile .hint{font-size:11px; color:var(--muted2); margin-top:4px}
    
    .status-badge{
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      font-size:14px;
      text-align:center;
      margin:12px 0;
    }
    .status-badge.ready{
      background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.08));
      border:1px solid rgba(34,197,94,.4);
      color: rgba(220,255,233,.95);
    }
    .status-badge.borderline{
      background: linear-gradient(180deg, rgba(79,209,197,.25), rgba(79,209,197,.08));
      border:1px solid rgba(79,209,197,.4);
      color: rgba(220,255,253,.95);
    }
    .status-badge.wait{
      background: linear-gradient(180deg, rgba(251,191,36,.25), rgba(251,191,36,.08));
      border:1px solid rgba(251,191,36,.4);
      color: rgba(254,252,232,.95);
    }
    .status-badge.notready{
      background: linear-gradient(180deg, rgba(255,90,122,.25), rgba(255,90,122,.08));
      border:1px solid rgba(255,90,122,.4);
      color: rgba(255,220,228,.95);
    }
    .status-badge.nodata{
      background: rgba(0,0,0,.14);
      border:1px solid var(--line);
      color: var(--muted);
    }
    
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .ctaRow a, .ctaRow button{
      text-decoration:none;
      color:var(--text);
      font-weight:900;
      padding:12px 16px;
      border-radius: 14px;
      border:1px solid rgba(79,209,197,.28);
      background: linear-gradient(180deg, rgba(79,209,197,.35), rgba(0,0,0,.18));
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition: transform .05s ease, filter .15s ease;
    }
    .ctaRow a:hover, .ctaRow button:hover{filter:brightness(1.06)}
    .ctaRow a:active, .ctaRow button:active{transform: translateY(1px)}
    .ctaRow a.secondary, .ctaRow button.secondary{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }

    .msg{
      display:none;
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      margin-top:10px;
    }
    .msg.show{display:block}
    .msg.err{border-color: rgba(255,90,122,.35); color: rgba(255,220,228,.92)}
    
    select{
      font-family: var(--sans);
      font-weight:700;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgb(22 26 43);
      color: var(--text);
      cursor:pointer;
      font-size:14px;
    }
    select:focus{
      outline:none;
      border-color: var(--accent);
    }
    
    .attempts-table{
      width:100%;
      border-collapse: collapse;
      margin-top:12px;
      font-size:12px;
    }
    .attempts-table th{
      text-align:left;
      padding:8px 6px;
      border-bottom:1px solid var(--line);
      font-weight:900;
      color:var(--muted2);
      font-size:11px;
      text-transform: uppercase;
      letter-spacing:.5px;
    }
    .attempts-table td{
      padding:8px 6px;
      border-bottom:1px solid rgba(255,255,255,.04);
      font-family: var(--mono);
    }
    .attempts-table tr:hover{
      background: rgba(255,255,255,.02);
    }
    
    .loading{
      text-align:center;
      padding:20px;
      color:var(--muted2);
      font-size:13px;
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Closing Coalition</div>
          <div class="sub">Home</div>
        </div>
      </div>

      <div class="nav">
        <span id="userEmail" class="pill">‚Äî</span>
        <a class="primary" href="exam.html">Exam</a>
        <a href="dictionary.html">Dictionary</a>
        <a href="caller/leadbase.html">Caller</a>
        <button id="btnLogout">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- Exam Readiness Dashboard -->
    <section class="card">
      <div class="head">
        <h2>üìä Exam Readiness</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="refreshBtn" class="secondary" style="padding:6px 12px;font-size:12px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--muted);border-radius:10px;cursor:pointer;font-weight:900">Refresh</button>
        </div>
      </div>
      <div class="body">
        <div id="readinessContent" class="loading">Loading readiness data...</div>
      </div>
    </section>

    <!-- Quick Actions & State Resources -->
    <section class="card">
      <div class="head">
        <h2>Quick Actions</h2>
      </div>
      <div class="body">
        <div class="ctaRow">
          <a class="primary" href="exam.html">Start Practice Exam</a>
          <a class="secondary" href="dictionary.html">Study Dictionary</a>
          <a class="secondary" href="caller/leadbase.html">Open Caller</a>
        </div>

        <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--line)">
          <div style="font-weight:900;margin-bottom:10px">üìö Get Exam Prep Course</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <select id="stateSelect" style="flex:1;min-width:200px">
              <option value="">Select your state...</option>
              <option value="alabama">Alabama</option>
              <option value="alaska">Alaska</option>
              <option value="arizona">Arizona</option>
              <option value="arkansas">Arkansas</option>
              <option value="california">California</option>
              <option value="colorado">Colorado</option>
              <option value="connecticut">Connecticut</option>
              <option value="delaware">Delaware</option>
              <option value="florida">Florida</option>
              <option value="georgia">Georgia</option>
              <option value="hawaii">Hawaii</option>
              <option value="idaho">Idaho</option>
              <option value="illinois">Illinois</option>
              <option value="indiana">Indiana</option>
              <option value="iowa">Iowa</option>
              <option value="kansas">Kansas</option>
              <option value="kentucky">Kentucky</option>
              <option value="louisiana">Louisiana</option>
              <option value="maine">Maine</option>
              <option value="maryland">Maryland</option>
              <option value="massachusetts">Massachusetts</option>
              <option value="michigan">Michigan</option>
              <option value="minnesota">Minnesota</option>
              <option value="mississippi">Mississippi</option>
              <option value="missouri">Missouri</option>
              <option value="montana">Montana</option>
              <option value="nebraska">Nebraska</option>
              <option value="nevada">Nevada</option>
              <option value="new-hampshire">New Hampshire</option>
              <option value="new-jersey">New Jersey</option>
              <option value="new-mexico">New Mexico</option>
              <option value="new-york">New York</option>
              <option value="north-carolina">North Carolina</option>
              <option value="north-dakota">North Dakota</option>
              <option value="ohio">Ohio</option>
              <option value="oklahoma">Oklahoma</option>
              <option value="oregon">Oregon</option>
              <option value="pennsylvania">Pennsylvania</option>
              <option value="rhode-island">Rhode Island</option>
              <option value="south-carolina">South Carolina</option>
              <option value="south-dakota">South Dakota</option>
              <option value="tennessee">Tennessee</option>
              <option value="texas">Texas</option>
              <option value="utah">Utah</option>
              <option value="vermont">Vermont</option>
              <option value="virginia">Virginia</option>
              <option value="washington">Washington</option>
              <option value="west-virginia">West Virginia</option>
              <option value="wisconsin">Wisconsin</option>
              <option value="wyoming">Wyoming</option>
            </select>
            <a id="xcelLink" href="#" target="_blank" style="display:none;padding:10px 16px;text-decoration:none;font-weight:900;border-radius:12px;background:linear-gradient(180deg, rgba(79,209,197,.35), rgba(0,0,0,.18));border:1px solid rgba(79,209,197,.3);color:var(--text)">Get Xcel Course ‚Üí</a>
          </div>
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </section>

  </main>

<script>
  /**********************
   * CONFIG
   **********************/
  const API_URL = "https://closing-coalition-api.thomaslancheros06.workers.dev";
  const LS_TOKEN = "cc_token";
  const LS_EXPIRES = "cc_expires_at";

  const $ = (id) => document.getElementById(id);

  function setMsg(type, text){
    const el = $("msg");
    el.className = "msg show" + (type === "err" ? " err" : "");
    el.textContent = text || "";
  }
  function clearMsg(){
    const el = $("msg");
    el.className = "msg";
    el.textContent = "";
  }

  function getToken(){ return localStorage.getItem(LS_TOKEN) || ""; }
  function getExpires(){ return localStorage.getItem(LS_EXPIRES) || ""; }

  async function api(action, payload){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ action, ...payload })
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error(text || "Invalid response"); }

    if (!data || data.ok !== true){
      const err = (data && (data.error || data.detail)) ? (data.error + (data.detail ? ` ‚Äî ${data.detail}` : "")) : "Request failed";
      throw new Error(err);
    }
    return data;
  }

  function logoutLocal(){
    localStorage.removeItem(LS_TOKEN);
    localStorage.removeItem(LS_EXPIRES);
  }

  function goLogin(){
    window.location.href = "index.html";
  }

  $("btnLogout").addEventListener("click", async () => {
    clearMsg();
    const token = getToken();
    try{
      if (token) { await api("logout", { token }).catch(()=>{}); }
    } finally {
      logoutLocal();
      goLogin();
    }
  });

  /**********************
   * STATE SELECTOR & XCEL LINK
   **********************/
  const stateSelect = $("stateSelect");
  const xcelLink = $("xcelLink");

  stateSelect.addEventListener("change", () => {
    const state = stateSelect.value;
    if (state) {
      xcelLink.href = `https://partners.xcelsolutions.com/${state}/insurance-license/life?partner=ariasevanson`;
      xcelLink.style.display = "inline-flex";
    } else {
      xcelLink.style.display = "none";
    }
  });

  /**********************
   * READINESS DASHBOARD
   **********************/
  async function loadReadinessData() {
    const exam = $("examSelect").value;
    const contentEl = $("readinessContent");
    
    contentEl.innerHTML = '<div class="loading">Loading readiness data...</div>';
    
    try {
      const data = await api("getExamMetrics", {
        token: getToken(),
        exam: exam
      });
      
      if (!data.ok) throw new Error(data.error || "Failed to load");
      
      renderReadiness(data);
    } catch(e) {
      console.error("Failed to load readiness:", e);
      contentEl.innerHTML = `
        <div style="text-align:center;padding:20px;color:var(--muted2)">
          <div style="font-size:16px;margin-bottom:8px">üì≠ No exam data yet</div>
          <div style="font-size:13px">Take a practice exam to see your readiness metrics!</div>
        </div>
      `;
    }
  }

  function renderReadiness(data) {
    const contentEl = $("readinessContent");
    const latest = data.latest || {};
    const attempts = data.attempts || [];
    
    // Determine status class
    const status = latest.readiness_status || "NO DATA";
    let statusClass = "nodata";
    if (status === "READY") statusClass = "ready";
    else if (status === "BORDERLINE") statusClass = "borderline";
    else if (status === "WAIT") statusClass = "wait";
    else if (status.includes("NOT READY")) statusClass = "notready";
    
    // Status explanations
    const statusExplanations = {
      "READY": "You're ready to pass! Your scores and speed are excellent.",
      "BORDERLINE": "You're close! A bit more practice will get you ready.",
      "WAIT": "Keep practicing. You need higher scores before taking the real exam.",
      "NOT READY (TIME)": "You're too slow. Practice speed to finish within time limits.",
      "NOT READY (DOMAIN)": "Weak domain detected. Study your weakest areas more.",
      "NO DATA": "No exam attempts recorded yet. Take a practice exam to start!"
    };
    
    const explanation = statusExplanations[status] || "Take more practice exams to improve your readiness.";
    
    // Render
    let html = `
      <!-- Status Badge -->
      <div class="status-badge ${statusClass}">
        <div style="font-size:16px;margin-bottom:4px">${status}</div>
        <div style="font-size:12px;opacity:.85">${explanation}</div>
      </div>
    `;
    
    if (latest.readiness_score_pct !== undefined && latest.readiness_score_pct > 0) {
      html += `
        <!-- Key Metrics -->
        <div class="grid3" style="margin-top:16px">
          <div class="tile">
            <div class="k">Recent Score</div>
            <div class="v">${latest.last_score_pct.toFixed(1)}%</div>
            <div class="hint">Latest exam result</div>
          </div>
          <div class="tile">
            <div class="k">3-Exam Average</div>
            <div class="v">${latest.last3_avg_pct.toFixed(1)}%</div>
            <div class="hint">Consistency metric</div>
          </div>
          <div class="tile">
            <div class="k">Weakest Domain</div>
            <div class="v">${latest.last_domain_low_pct.toFixed(1)}%</div>
            <div class="hint">Lowest topic score</div>
          </div>
          <div class="tile">
            <div class="k">Time/Question</div>
            <div class="v">${latest.last_time_per_q_sec.toFixed(1)}s</div>
            <div class="hint">Average speed</div>
          </div>
          <div class="tile">
            <div class="k">Readiness Score</div>
            <div class="v">${latest.readiness_score_pct.toFixed(1)}%</div>
            <div class="hint">Pass probability</div>
          </div>
          <div class="tile">
            <div class="k">Last Attempt</div>
            <div class="v">${formatDate(latest.last_attempt_at)}</div>
            <div class="hint">Most recent</div>
          </div>
        </div>
        
        <!-- Understanding Your Metrics -->
        <div style="margin-top:20px;padding:14px;border-radius:12px;background:rgba(0,0,0,.14);border:1px solid var(--line)">
          <div style="font-weight:900;margin-bottom:10px;font-size:13px">üìñ Understanding Your Metrics</div>
          <div style="font-size:12px;color:var(--muted);line-height:1.6">
            <div style="margin-bottom:6px"><strong>Readiness Score</strong> = Your probability of passing (0.5√óRecent + 0.3√óAverage + 0.2√óWeakest)</div>
            <div style="margin-bottom:6px"><strong>Recent Score</strong> = Your last exam performance</div>
            <div style="margin-bottom:6px"><strong>3-Exam Average</strong> = Consistency across your last 3 attempts</div>
            <div style="margin-bottom:6px"><strong>Weakest Domain</strong> = Your lowest-scoring topic area</div>
            <div><strong>Time/Question</strong> = Must be ‚â§69s (60s + 15% buffer) to pass time gate</div>
          </div>
        </div>
      `;
      
      if (attempts.length > 0) {
        html += `
          <!-- Recent Attempts -->
          <div style="margin-top:20px">
            <div style="font-weight:900;margin-bottom:10px;font-size:13px">üìú Last ${Math.min(attempts.length, 10)} Attempts</div>
            <table class="attempts-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Score</th>
                  <th>Domain</th>
                  <th>Time/Q</th>
                  <th>CRS</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        attempts.forEach(a => {
          const statusShort = a.readiness_status.replace("NOT READY (", "").replace(")", "").substring(0, 10);
          html += `
            <tr>
              <td>${formatDate(a.timestamp)}</td>
              <td>${a.total_score_pct.toFixed(0)}%</td>
              <td>${a.domain_low_pct.toFixed(0)}%</td>
              <td>${a.time_per_q_sec.toFixed(1)}s</td>
              <td>${a.readiness_score_pct.toFixed(0)}%</td>
              <td style="color:${getStatusColor(a.readiness_status)}">${statusShort}</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
      }
    } else {
      html += `
        <div style="text-align:center;padding:30px 20px;color:var(--muted2)">
          <div style="font-size:48px;margin-bottom:12px">üìù</div>
          <div style="font-size:16px;font-weight:900;margin-bottom:8px">No exam attempts yet</div>
          <div style="font-size:13px">Take your first practice exam to start tracking your readiness!</div>
          <div style="margin-top:16px">
            <a href="exam.html" style="display:inline-flex;padding:12px 20px;background:linear-gradient(180deg, rgba(79,209,197,.35), rgba(0,0,0,.18));border:1px solid rgba(79,209,197,.3);border-radius:14px;color:var(--text);text-decoration:none;font-weight:900">Start Practice Exam ‚Üí</a>
          </div>
        </div>
      `;
    }
    
    contentEl.innerHTML = html;
  }

  function formatDate(isoString) {
    if (!isoString) return "‚Äî";
    const d = new Date(isoString);
    const now = new Date();
    const diffMs = now - d;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function getStatusColor(status) {
    if (status === "READY") return "var(--ok)";
    if (status === "BORDERLINE") return "var(--accent)";
    if (status.includes("NOT READY")) return "var(--danger)";
    return "var(--muted2)";
  }

  // Event listeners
  $("examSelect").addEventListener("change", loadReadinessData);
  $("refreshBtn").addEventListener("click", loadReadinessData);

  // Protect page: must have valid token
  (async () => {
    const token = getToken();
    const exp = getExpires();

    if (!token){
      goLogin();
      return;
    }

    try{
      const me = await api("me", { token });
      // success
      $("userEmail").textContent = me.loginEmail || "‚Äî";
      
      // Load readiness data
      await loadReadinessData();
    } catch (e){
      // token invalid/expired
      logoutLocal();
      setMsg("err", "Session expired. Please log in again.");
      setTimeout(goLogin, 600);
    }
  })();
</script>
</body>
</html>

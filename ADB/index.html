<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ADB - Client Sign Certificate</title>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b0f1a;color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#121a2a;border:1px solid #22314f;border-radius:14px;padding:14px;margin:12px 0}
    button,input{font-size:18px;padding:14px;border-radius:12px;border:1px solid #2a3b60;background:#0e1524;color:#fff;width:100%}
    button{border:none;cursor:pointer}
    button.primary{background:#2b6cff;font-weight:900}
    button:disabled{opacity:.5;cursor:not-allowed}
    .pdfBox{height:520px;overflow:auto;border-radius:12px;border:1px solid #2a3b60;background:#0a1020}
    .sticky{position:sticky;top:0;padding:10px;background:rgba(18,26,42,.92);backdrop-filter:blur(8px);border-bottom:1px solid #22314f;z-index:2}
    canvas{width:100%;height:240px;background:#fff;border-radius:12px;touch-action:none}
    .small{font-size:13px;opacity:.8;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:220px}
    iframe{width:100%;height:720px;border:1px solid #2a3b60;border-radius:12px;background:#fff}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="small"><b>Token:</b> <span id="tokenTxt">…</span></div>
    <div class="small" style="margin-top:8px">
      By signing, you consent to electronic signature and agree it is your legal signature.
    </div>
    <div id="status" class="small" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="small"><b>Step 1:</b> Review the certificate. <b>Scroll to the bottom</b> to enable signing.</div>
    <div class="pdfBox" id="pdfBox" style="margin-top:10px">
      <div class="sticky" id="scrollMsg">⬇️ PLEASE SCROLL to the bottom to continue…</div>
      <iframe id="pdfFrame" title="Certificate Preview"></iframe>
      <div id="bottomMarker" style="height:40px"></div>
    </div>

    <button id="enableBtn" class="primary" disabled style="margin-top:12px">PRESS HERE TO SIGN</button>
  </div>

  <div class="card" id="sigCard" style="display:none">
    <div class="small"><b>Step 2:</b> Sign below (use finger or mouse)</div>
    <canvas id="sigCanvas" width="1400" height="320"></canvas>

    <div class="row" style="margin-top:10px">
      <button id="clearBtn">Clear Signature</button>
      <button id="submitBtn" class="primary">SUBMIT SIGNATURE</button>
    </div>

    <div id="doneWrap" style="display:none;margin-top:10px">
      <div class="small" style="color:#6ba3ff;margin-bottom:10px">
        ✅ Signature submitted! Agent will review and complete the certificate.
      </div>
    </div>
  </div>

</div>

<script>
const WORKER_BASE = "https://closing-coalition-api.thomaslancheros06.workers.dev";
const ADB_API_URL = `${WORKER_BASE}/adb`;
const PDF_URL = "/ADB/ADB.pdf";

const FIELD_CORDS = {
  NAME_CORDS:           { x: 58,  y: 455, size: 13 },
  DOB_CORDS:            { x: 340, y: 455, size: 12 },
  PHONE_CORDS:          { x: 464, y: 457, size: 12 },
  ADDRESS_CORDS:        { x: 57,  y: 421, size: 12 },
  CITY_CORDS:           { x: 276, y: 420, size: 12 },
  STATE_CORDS:          { x: 451, y: 421, size: 12 },
  ZIP_CORDS:            { x: 491, y: 421, size: 12 },
  BENEFICIARY_CORDS:    { x: 56,  y: 386, size: 12 },
  REL_CORDS:            { x: 318, y: 386, size: 12 },
  INSURED_NAME_2:       { x: 56,  y: 88, size: 12 },
  INSURED_DOB_2:        { x: 317, y: 90, size: 12 },
  AGENT_NAME_2:         { x: 317, y: 52, size: 12 },
  CLIENT_SIG_BOX:       { x: 58,  y: 54, w: 240, h: 55 }, // Client finger signature
};

const token = new URLSearchParams(location.search).get("adb") || "";
tokenTxt.textContent = token || "(missing)";

async function getRecord(){
  const url = `${ADB_API_URL}?action=getByToken&token=${encodeURIComponent(token)}`;
  const res = await fetch(url);
  const json = await res.json().catch(()=>({}));
  if (!res.ok || json.ok === false) throw new Error(json.error || "Failed to load token record");
  return json.record;
}

async function loadPdfBytes(){
  const res = await fetch(PDF_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("Failed to load ADB.pdf");
  return new Uint8Array(await res.arrayBuffer());
}

async function buildPrefilledPdf(record){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const bytes = await loadPdfBytes();
  const pdfDoc = await PDFDocument.load(bytes);
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const page = pdfDoc.getPages()[0];

  const drawText = (cords, text) => {
    if(!text) return;
    page.drawText(String(text), { x:cords.x, y:cords.y, size:cords.size||12, font, color: rgb(0,0,0) });
  };

  drawText(FIELD_CORDS.NAME_CORDS, record.clientName);
  drawText(FIELD_CORDS.DOB_CORDS, record.dob);
  drawText(FIELD_CORDS.PHONE_CORDS, record.phone);
  drawText(FIELD_CORDS.ADDRESS_CORDS, record.address);
  drawText(FIELD_CORDS.CITY_CORDS, record.city);
  drawText(FIELD_CORDS.STATE_CORDS, record.state);
  drawText(FIELD_CORDS.ZIP_CORDS, record.zip);
  drawText(FIELD_CORDS.BENEFICIARY_CORDS, record.beneficiary);
  drawText(FIELD_CORDS.REL_CORDS, record.relationship);
  drawText(FIELD_CORDS.INSURED_NAME_2, record.clientName);
  drawText(FIELD_CORDS.INSURED_DOB_2, record.dob);
  drawText(FIELD_CORDS.AGENT_NAME_2, record.agentName);

  const outBytes = await pdfDoc.save();
  return outBytes;
}

function blobUrl(bytes){
  return URL.createObjectURL(new Blob([bytes], {type:"application/pdf"}));
}

let RECORD = null;
let PREFILLED_PDF_BYTES = null;

(async ()=>{
  try{
    if(!token) throw new Error("Missing token");
    status.textContent = "Loading your certificate…";
    RECORD = await getRecord();
    PREFILLED_PDF_BYTES = await buildPrefilledPdf(RECORD);
    pdfFrame.src = blobUrl(PREFILLED_PDF_BYTES);
    status.textContent = "✅ Loaded. Please scroll through the certificate.";
  } catch(err){
    status.textContent = "❌ Error: " + err.message;
  }
})();

// Scroll gate
const io = new IntersectionObserver((entries)=>{
  if(entries.some(e=>e.isIntersecting)){
    enableBtn.disabled = false;
    scrollMsg.textContent = "✅ Scroll complete. You can sign now.";
  }
},{ root: pdfBox, threshold: 0.8 });
io.observe(bottomMarker);

enableBtn.onclick = ()=>{
  sigCard.style.display = "block";
  sigCard.scrollIntoView({behavior:"smooth"});
};

// Signature canvas
const canvas = sigCanvas;
const ctx = canvas.getContext("2d");
ctx.lineWidth = 6;
ctx.lineCap = "round";
ctx.strokeStyle = "#000";
let drawing=false, last=null;

function pos(evt){
  const r=canvas.getBoundingClientRect();
  return {
    x:(evt.clientX-r.left)*(canvas.width/r.width),
    y:(evt.clientY-r.top)*(canvas.height/r.height)
  };
}
canvas.addEventListener("pointerdown", e=>{canvas.setPointerCapture(e.pointerId); drawing=true; last=pos(e);});
canvas.addEventListener("pointermove", e=>{
  if(!drawing) return;
  const p=pos(e);
  ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke();
  last=p;
});
canvas.addEventListener("pointerup", ()=>{drawing=false; last=null;});
canvas.addEventListener("pointercancel", ()=>{drawing=false; last=null;});

clearBtn.onclick = ()=>ctx.clearRect(0,0,canvas.width,canvas.height);

function canvasSigDataUrl(){ return canvas.toDataURL("image/png"); }
function toBase64(bytes){
  let bin="", chunk=0x8000;
  for(let i=0;i<bytes.length;i+=chunk) bin += String.fromCharCode(...bytes.subarray(i,i+chunk));
  return btoa(bin);
}

async function postJSON(url, payload){
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const json = await res.json().catch(()=>({}));
  if(!res.ok || json.ok===false) throw new Error(json.error || `Request failed (${res.status})`);
  return json;
}

// Submit client signature
submitBtn.onclick = async ()=>{
  try{
    submitBtn.disabled = true;
    if(!RECORD) throw new Error("Record not loaded");

    const { PDFDocument } = PDFLib;
    const pdfDoc = await PDFDocument.load(PREFILLED_PDF_BYTES);
    const page = pdfDoc.getPages()[0];

    const sigUrl = canvasSigDataUrl();
    const pngBytes = await fetch(sigUrl).then(r=>r.arrayBuffer());
    const png = await pdfDoc.embedPng(pngBytes);

    // Place client signature
    page.drawImage(png, {
      x: FIELD_CORDS.CLIENT_SIG_BOX.x,
      y: FIELD_CORDS.CLIENT_SIG_BOX.y,
      width: FIELD_CORDS.CLIENT_SIG_BOX.w,
      height: FIELD_CORDS.CLIENT_SIG_BOX.h
    });

    const clientSignedPdfBytes = await pdfDoc.save();
    const clientSignedPdfBase64 = toBase64(new Uint8Array(clientSignedPdfBytes));
    const clientSigPngBase64 = sigUrl.split(",")[1];

    status.textContent = "Saving your signature…";

    await postJSON(ADB_API_URL, {
      action: "saveClientSignature",
      token,
      clientSignedPdfBase64,
      clientSigPngBase64,
      userAgent: navigator.userAgent
    });

    status.textContent = "✅ Signature submitted!";
    doneWrap.style.display = "block";
    submitBtn.style.display = "none";
    clearBtn.style.display = "none";

  } catch(err){
    status.textContent = "❌ Error: " + err.message;
  } finally {
    submitBtn.disabled = false;
  }
};
</script>
</body>
</html>

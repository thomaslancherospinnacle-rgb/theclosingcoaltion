<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>Lead Dialer</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --ink:#333333;
      --muted:#666666;
      --line:#d0d0d0;
      --brand:#007bff;
      --brand2:#0056b3;
      --good:#28a745;
      --topbar:#2c3e50;
      --shadow:0 2px 4px rgba(0,0,0,.1);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--ink);background:var(--bg);font-size:14px}
    a{color:inherit}
    .app{min-height:100vh;display:flex;flex-direction:column}
    .topbar{
      height:50px;background:var(--topbar);color:#fff;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 20px;box-shadow:var(--shadow);
    }
    .topbar .title{font-weight:600;font-size:16px;}
    .topbar .right{display:flex;gap:12px;align-items:center}
    .pill{
      background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);
      color:#fff;padding:4px 12px;font-size:13px;border-radius:4px;
      display:flex;align-items:center;gap:8px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);
      color:#fff;padding:6px 12px;cursor:pointer;font-weight:500;font-size:13px;border-radius:4px;
    }
    .btn:hover{background:rgba(255,255,255,.2)}
    .wrap{max-width:1200px;margin:20px auto;padding:0 20px;width:100%;}
    .panel{background:var(--card);border:1px solid var(--line);box-shadow:var(--shadow);border-radius:8px;}
    .hidden{display:none !important}
    .input{width:100%;padding:10px 14px;border:1px solid var(--line);border-radius:6px;font-size:16px;outline:none;}
    .input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,123,255,.15)}
    .primary{
      background:var(--brand);color:#fff;border:none;padding:12px 20px;cursor:pointer;
      font-weight:600;font-size:14px;border-radius:6px;width:100%;
    }
    .primary:hover{background:var(--brand2)}
    .ghost{background:#fff;color:var(--ink);border:1px solid var(--line);padding:10px 16px;cursor:pointer;border-radius:6px;}
    .ghost:hover{background:#f8f9fa}

    /* Auth Overlay */
    .auth-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.85);
      display:flex;align-items:center;justify-content:center;z-index:1000;
    }
    .auth-box{
      background:#fff;padding:32px;border-radius:12px;width:90%;max-width:400px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
    }
    .auth-box h2{margin:0 0 8px;font-size:24px;color:#333;}
    .auth-box p{margin:0 0 24px;color:#666;font-size:14px;}
    .auth-box .error{background:#fee;border:1px solid #fcc;color:#c00;padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;}
    .auth-box .info{background:#e8f4fd;border:1px solid #b8daff;color:#004085;padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;}

    /* Source Selection */
    .source-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:20px;}
    .source-card{
      background:#fff;border:2px solid var(--line);border-radius:8px;padding:16px;cursor:pointer;
      transition:all .2s;text-align:center;
    }
    .source-card:hover{border-color:var(--brand);background:#f8f9fa;}
    .source-card.selected{border-color:var(--brand);background:#e8f4fd;}
    .source-card .icon{font-size:28px;margin-bottom:8px;}
    .source-card .name{font-weight:600;font-size:14px;}
    .source-card .count{font-size:12px;color:var(--muted);margin-top:4px;}

    /* Lead List */
    .list-header{padding:12px 16px;border-bottom:2px solid var(--line);display:grid;gap:16px;background:#f8f9fa;font-weight:600;font-size:13px;}
    .lead-row{padding:12px 16px;border-bottom:1px solid var(--line);display:grid;gap:16px;align-items:center;}
    .lead-row:hover{background:#f8f9fa}
    .name-link{color:var(--brand);font-weight:600;cursor:pointer;}
    .name-link:hover{text-decoration:underline}
    .icons{display:flex;gap:8px;justify-content:flex-end}
    .icon-btn{width:32px;height:32px;border:1px solid var(--line);background:#fff;cursor:pointer;display:grid;place-items:center;font-size:16px;border-radius:4px;}
    .icon-btn:hover{background:#f8f9fa}
    .status-line{grid-column:1/-1;color:var(--muted);font-size:12px;margin-top:6px;padding:8px 12px;background:#f8f9fa;border:1px solid var(--line);border-radius:4px;}

    /* Detail View */
    .detail-head{padding:16px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;background:#f8f9fa;}
    .detail-body{padding:16px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;font-size:14px;margin-bottom:8px}
    .kv .k{color:var(--muted);font-weight:600}
    .actions{margin-top:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .action{border:1px solid var(--line);background:#fff;padding:12px;display:flex;flex-direction:column;gap:6px;align-items:center;cursor:pointer;border-radius:6px;}
    .action:hover{background:#f8f9fa}
    .action strong{font-size:12px}
    .action span{font-size:18px}
    .action.disabled{opacity:.4;cursor:not-allowed;pointer-events:none}

    /* Disposition Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;z-index:100}
    .sheet{background:#fff;width:100%;max-width:500px;border-radius:16px 16px 0 0;max-height:80vh;overflow:auto}
    .sheethead{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;font-weight:600}
    .sheetbody{padding:16px}
    .dispo-btn{width:100%;padding:14px;margin-bottom:8px;border:1px solid var(--line);background:#fff;cursor:pointer;text-align:left;border-radius:8px;font-size:14px}
    .dispo-btn:hover{background:#f0f0f0}
    .dispo-btn.appt{border-color:var(--good);background:#e8f5e9}
    .dispo-btn.resolve{border-color:#ff9800;background:#fff3e0}

    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;opacity:0;transition:opacity .3s;z-index:200}
    .toast.show{opacity:1}

    @media(max-width:600px){
      .actions{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Auth Overlay (Loading/Redirect) -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-box" style="text-align:center">
      <div style="font-size:48px;margin-bottom:16px">üîê</div>
      <h2 style="margin-bottom:8px">Verifying Session</h2>
      <p id="authStatus">Checking authentication...</p>
    </div>
  </div>

  <!-- Top Bar -->
  <div class="topbar">
    <div class="title">üìû Lead Dialer</div>
    <div class="right">
      <div class="pill" id="userPill">
        <span id="userName">‚Äî</span>
      </div>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Source Selection View -->
  <div id="sourceView" class="wrap hidden">
    <div class="panel" style="padding:24px">
      <h2 style="margin:0 0 8px">üìÅ Select Lead Source</h2>
      <p style="color:var(--muted);margin:0">Choose which leads you want to call today.</p>
      <div id="sourceGrid" class="source-grid">
        <!-- Populated dynamically -->
      </div>
      <div style="margin-top:20px">
        <button class="primary" id="loadSourceBtn" onclick="loadSelectedSource()" disabled>Load Selected Source</button>
      </div>
    </div>
  </div>

  <!-- Lead List View -->
  <div id="listView" class="wrap hidden">
    <div class="panel">
      <div style="padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div>
          <strong id="sourceTitle">Leads</strong>
          <span class="muted" id="leadCount"></span>
        </div>
        <div style="display:flex;gap:8px">
          <button class="ghost" onclick="showSourceSelection()">‚Üê Back</button>
          <button class="ghost" onclick="exportLeads()">Export CSV</button>
        </div>
      </div>
      <div class="list-header" id="listHeader"></div>
      <div id="leadList"></div>
    </div>
  </div>

  <!-- Detail View -->
  <div id="detailView" class="wrap hidden">
    <div class="panel">
      <div class="detail-head">
        <div>
          <div style="font-size:20px;font-weight:700" id="dName"></div>
          <div style="color:var(--muted);font-size:13px;margin-top:4px" id="dMeta"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="ghost" id="prevLead" onclick="navLead(-1)">‚Üê</button>
          <button class="ghost" id="nextLead" onclick="navLead(1)">‚Üí</button>
          <button class="ghost" onclick="showListView()">Back to List</button>
        </div>
      </div>
      <div class="detail-body">
        <div id="detailKVs"></div>
        <div class="actions">
          <a class="action" id="callMobile" href="#">
            <span>üì±</span>
            <strong>Call Mobile</strong>
          </a>
          <a class="action" id="callHome" href="#">
            <span>üè†</span>
            <strong>Call Home</strong>
          </a>
          <a class="action" id="sendText" href="#">
            <span>üí¨</span>
            <strong>Send Text</strong>
          </a>
          <a class="action" id="setAppt" href="#" onclick="setAppointment(event)">
            <span>üìÖ</span>
            <strong>Set Appt</strong>
          </a>
        </div>
        <div style="margin-top:20px">
          <strong>üìù Call Outcome</strong>
          <div id="dispoList" style="margin-top:12px"></div>
        </div>
        <div style="margin-top:20px">
          <strong>üìú History</strong>
          <div id="historyBox" style="margin-top:8px;background:#f8f9fa;padding:12px;border-radius:6px;font-size:13px;max-height:200px;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Disposition Modal -->
<div class="overlay hidden" id="overlay">
  <div class="sheet">
    <div class="sheethead">
      <div>Call Outcome</div>
      <button class="ghost" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="sheetbody" id="modalDispoList"></div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script src="../config.js"></script>
<script>
// ============================================================
// STATE & CONSTANTS
// ============================================================
let currentUser = null;
let availableSources = [];
let selectedSource = null;
let leads = [];
let currentLeadIndex = -1;

const DISPOSITIONS = [
  { key: "No Pick Up", desc: "Client did not answer", class: "" },
  { key: "Appointment Set", desc: "Virtual appointment scheduled", class: "appt" },
  { key: "RESOLVE", desc: "Completed - no more calls needed", class: "resolve" }
];

// ============================================================
// AUTH HELPERS (Same as other apps)
// ============================================================
function getToken() {
  return localStorage.getItem('cc_token') || '';
}

function getExpires() {
  return localStorage.getItem('cc_expires_at') || '';
}

function setSession(token, expiresAt) {
  localStorage.setItem('cc_token', token);
  localStorage.setItem('cc_expires_at', expiresAt);
}

function clearSession() {
  localStorage.removeItem('cc_token');
  localStorage.removeItem('cc_expires_at');
}

function goLogin() {
  window.location.href = '../index.html';
}

// API helper - same pattern as other apps
async function api(action, payload = {}) {
  const url = `${CFWORKER}${action}`;
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!data.ok) {
    throw new Error(data.error || 'Request failed');
  }
  return data;
}

// ============================================================
// AUTH OVERLAY
// ============================================================
function showAuthOverlay() {
  document.getElementById('authOverlay').classList.remove('hidden');
}

function hideAuthOverlay() {
  document.getElementById('authOverlay').classList.add('hidden');
}

function updateAuthStatus(msg) {
  const el = document.getElementById('authStatus');
  if (el) el.textContent = msg;
}

// ============================================================
// MAIN INIT - Check token via CFWORKER
// ============================================================
(async () => {
  const token = getToken();
  
  if (!token) {
    goLogin();
    return;
  }

  try {
    updateAuthStatus('Verifying session...');
    
    // Check token via CFWORKER - same as other apps
    const me = await api('me', { token });
    
    // Success - user is authenticated
    currentUser = {
      email: me.loginEmail,
      username: me.username || me.loginEmail.split('@')[0].replace('.ail', ''),
      callingFor: me.callingFor || '',
      calendlyUrl: me.calendlyUrl || '',
      assignedTabs: me.assignedTabs || []
    };
    
    // Update UI
    document.getElementById('userName').textContent = currentUser.username;
    hideAuthOverlay();
    
    // Load available lead packs
    updateAuthStatus('Loading lead packs...');
    await loadAvailableSources();
    showSourceSelection();
    
  } catch (e) {
    console.error('Auth error:', e);
    clearSession();
    goLogin();
  }
})();

// ============================================================
// SOURCE SELECTION - Load available lead packs
// ============================================================
async function loadAvailableSources() {
  try {
    // Get caller's permissions from LEADSDB
    const permRes = await fetch(`${LEADSDB}?action=getPermissions&caller=${encodeURIComponent(currentUser.username)}`);
    const permissions = await permRes.json();
    
    console.log('User permissions:', permissions);

    // Get all CSV sources from LEADSDB
    const csvRes = await fetch(`${LEADSDB}?action=getSources`);
    const csvSources = await csvRes.json();

    // Get all REFDB tabs
    const refRes = await fetch(`${REFDB}?action=listUsers`);
    const refSources = await refRes.json();

    availableSources = [];

    // Add permitted CSV sources (LEADDB)
    if (Array.isArray(csvSources)) {
      csvSources.forEach(src => {
        const hasAccess = permissions.some(p => p.sourceType === 'CSV' && p.sourceName === src.name);
        if (hasAccess) {
          availableSources.push({
            name: src.name,
            type: 'LEADDB',
            count: src.leadCount || 0,
            icon: 'üìÅ'
          });
        }
      });
    }

    // Add permitted REFDB sources
    if (Array.isArray(refSources)) {
      refSources.forEach(src => {
        const hasAccess = permissions.some(p => p.sourceType === 'Referrals' && p.sourceName === src.name);
        if (hasAccess) {
          availableSources.push({
            name: src.name,
            type: 'REFDB',
            count: src.referralCount || 0,
            icon: 'üë§',
            owner: src.name
          });
        }
      });
    }

    console.log('Available sources:', availableSources);
    renderSourceGrid();
    
  } catch (err) {
    console.error('Error loading sources:', err);
    toast('Error loading lead packs');
  }
}

function renderSourceGrid() {
  const grid = document.getElementById('sourceGrid');
  
  if (availableSources.length === 0) {
    grid.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:12px">üì≠</div>
        <div style="font-size:16px;font-weight:600;margin-bottom:8px">No Lead Packs Assigned</div>
        <div style="font-size:13px">Contact your admin to get access to lead sources.</div>
      </div>
    `;
    return;
  }

  grid.innerHTML = availableSources.map((src, i) => `
    <div class="source-card" data-index="${i}" onclick="selectSource(${i})">
      <div class="icon">${src.icon}</div>
      <div class="name">${src.name}</div>
      <div class="count">${src.count} leads ‚Ä¢ ${src.type}</div>
    </div>
  `).join('');
}

function selectSource(index) {
  document.querySelectorAll('.source-card').forEach(el => el.classList.remove('selected'));
  document.querySelector(`.source-card[data-index="${index}"]`).classList.add('selected');
  selectedSource = availableSources[index];
  document.getElementById('loadSourceBtn').disabled = false;
}

async function loadSelectedSource() {
  if (!selectedSource) return;

  const btn = document.getElementById('loadSourceBtn');
  btn.textContent = 'Loading...';
  btn.disabled = true;

  try {
    if (selectedSource.type === 'LEADDB') {
      const res = await fetch(`${LEADSDB}?action=getLeads&source=${encodeURIComponent(selectedSource.name)}`);
      const data = await res.json();
      leads = Array.isArray(data) ? data : [];
    } else if (selectedSource.type === 'REFDB') {
      const res = await fetch(`${REFDB}?user=${encodeURIComponent(selectedSource.name)}`);
      const data = await res.json();
      leads = Array.isArray(data) ? data.map(ref => ({
        name: ref.refName,
        phone: ref.refNumber,
        relation: ref.refRelation,
        sponsor: ref.sponsorName,
        sponsorPhone: ref.sponsorNumber,
        outcome: ref.outcome || 'Not Contacted',
        tabOwner: selectedSource.name
      })) : [];
    }

    document.getElementById('sourceTitle').textContent = selectedSource.name;
    document.getElementById('leadCount').textContent = `(${leads.length} leads)`;
    renderLeadList();
    showListView();
    
  } catch (err) {
    console.error('Error loading leads:', err);
    toast('Error loading leads');
  } finally {
    btn.textContent = 'Load Selected Source';
    btn.disabled = false;
  }
}

function showSourceSelection() {
  document.getElementById('sourceView').classList.remove('hidden');
  document.getElementById('listView').classList.add('hidden');
  document.getElementById('detailView').classList.add('hidden');
}

function logout() {
  clearSession();
  goLogin();
}

// ============================================================
// LEAD LIST
// ============================================================
function renderLeadList() {
  const header = document.getElementById('listHeader');
  const list = document.getElementById('leadList');

  header.style.gridTemplateColumns = '2fr 1.5fr 1fr 80px';
  header.innerHTML = '<div>Name</div><div>Phone</div><div>Status</div><div></div>';

  list.innerHTML = leads.map((lead, i) => {
    const phone = formatPhone(lead.phone);
    const status = lead.outcome || lead.status || 'New';
    return `
      <div class="lead-row" style="grid-template-columns:2fr 1.5fr 1fr 80px">
        <div><span class="name-link" onclick="openLead(${i})">${(lead.name || '‚Äî').toUpperCase()}</span></div>
        <div>${phone.pretty}</div>
        <div><span style="font-size:12px;padding:4px 8px;background:#f0f0f0;border-radius:4px">${status}</span></div>
        <div class="icons">
          <button class="icon-btn" onclick="openLead(${i});openCallModal()">üìû</button>
        </div>
      </div>
    `;
  }).join('');
}

function showListView() {
  document.getElementById('sourceView').classList.add('hidden');
  document.getElementById('listView').classList.remove('hidden');
  document.getElementById('detailView').classList.add('hidden');
}

// ============================================================
// LEAD DETAIL
// ============================================================
function openLead(index) {
  currentLeadIndex = index;
  const lead = leads[index];

  document.getElementById('dName').textContent = (lead.name || '‚Äî').toUpperCase();
  document.getElementById('dMeta').textContent = `${selectedSource.name} ‚Ä¢ ${selectedSource.type}`;

  const phone = formatPhone(lead.phone);
  const homePhone = formatPhone(lead.sponsorPhone || lead.home);

  let kvHtml = `
    <div class="kv"><div class="k">Mobile</div><div class="v">${phone.ok ? `<a href="${phone.tel}">${phone.pretty}</a>` : '‚Äî'}</div></div>
    <div class="kv"><div class="k">Home/Sponsor</div><div class="v">${homePhone.ok ? `<a href="${homePhone.tel}">${homePhone.pretty}</a>` : '‚Äî'}</div></div>
  `;

  if (lead.relation) kvHtml += `<div class="kv"><div class="k">Relation</div><div class="v">${lead.relation}</div></div>`;
  if (lead.sponsor) kvHtml += `<div class="kv"><div class="k">Sponsor</div><div class="v">${lead.sponsor}</div></div>`;
  if (lead.address) kvHtml += `<div class="kv"><div class="k">Address</div><div class="v">${lead.address}</div></div>`;

  document.getElementById('detailKVs').innerHTML = kvHtml;

  // Set up action buttons
  document.getElementById('callMobile').href = phone.ok ? phone.tel : '#';
  document.getElementById('callMobile').classList.toggle('disabled', !phone.ok);
  document.getElementById('callHome').href = homePhone.ok ? homePhone.tel : '#';
  document.getElementById('callHome').classList.toggle('disabled', !homePhone.ok);
  document.getElementById('sendText').href = phone.ok ? `sms:${phone.digits}` : '#';
  document.getElementById('sendText').classList.toggle('disabled', !phone.ok);

  renderDispositions();
  renderHistory(lead);

  document.getElementById('sourceView').classList.add('hidden');
  document.getElementById('listView').classList.add('hidden');
  document.getElementById('detailView').classList.remove('hidden');
}

function navLead(dir) {
  const newIndex = currentLeadIndex + dir;
  if (newIndex >= 0 && newIndex < leads.length) {
    openLead(newIndex);
  }
}

function renderDispositions() {
  const container = document.getElementById('dispoList');
  container.innerHTML = DISPOSITIONS.map(d => `
    <button class="dispo-btn ${d.class}" onclick="setDisposition('${d.key}')">
      <strong>${d.key}</strong><br><span style="font-size:12px;color:#666">${d.desc}</span>
    </button>
  `).join('');
}

function renderHistory(lead) {
  const histKey = `history:${selectedSource.name}:${lead.phone}`;
  const history = JSON.parse(localStorage.getItem(histKey) || '[]');
  
  const box = document.getElementById('historyBox');
  if (history.length === 0) {
    box.innerHTML = '<span style="color:var(--muted)">No history yet</span>';
  } else {
    box.innerHTML = history.map(h => `<div style="margin-bottom:8px"><strong>${h.outcome}</strong> - ${h.timestamp}</div>`).join('');
  }
}

// ============================================================
// DISPOSITIONS & OUTCOMES
// ============================================================
async function setDisposition(outcome) {
  const lead = leads[currentLeadIndex];
  
  // Save to local history
  const histKey = `history:${selectedSource.name}:${lead.phone}`;
  const history = JSON.parse(localStorage.getItem(histKey) || '[]');
  history.push({ outcome, timestamp: new Date().toLocaleString() });
  localStorage.setItem(histKey, JSON.stringify(history));

  // Update lead in memory
  lead.outcome = outcome;
  lead.status = outcome;

  // Save to backend
  try {
    if (selectedSource.type === 'LEADDB') {
      await fetch(LEADSDB, {
        method: 'POST',
        body: JSON.stringify({
          action: 'updateOutcome',
          source: selectedSource.name,
          phone: lead.phone,
          outcome: outcome
        })
      });
    } else if (selectedSource.type === 'REFDB') {
      await fetch(REFDB, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'updateReferral',
          oldName: lead.name,
          referralData: {
            user: selectedSource.name,
            refName: lead.name,
            refNumber: lead.phone,
            refRelation: lead.relation || '',
            sponsorName: lead.sponsor || '',
            sponsorNumber: lead.sponsorPhone || '',
            outcome: outcome
          }
        })
      });
    }
  } catch (err) {
    console.error('Error saving outcome:', err);
  }

  renderHistory(lead);
  renderLeadList();
  toast(`Saved: ${outcome}`);
  closeOverlay();
}

function openCallModal() {
  const modal = document.getElementById('modalDispoList');
  modal.innerHTML = DISPOSITIONS.map(d => `
    <button class="dispo-btn ${d.class}" onclick="setDisposition('${d.key}')">
      <strong>${d.key}</strong><br><span style="font-size:12px;color:#666">${d.desc}</span>
    </button>
  `).join('');
  document.getElementById('overlay').classList.remove('hidden');
}

function closeOverlay() {
  document.getElementById('overlay').classList.add('hidden');
}

// ============================================================
// CALENDLY APPOINTMENT SETTING
// ============================================================
function setAppointment(e) {
  e.preventDefault();
  const lead = leads[currentLeadIndex];
  
  let calendlyUrl = '';
  
  if (selectedSource.type === 'REFDB') {
    // For REFDB: Use tab owner's Calendly
    const ownerName = selectedSource.name.toLowerCase().replace(/[^a-z]/g, '');
    calendlyUrl = `https://calendly.com/${ownerName}-ail/30min`;
  } else if (selectedSource.type === 'LEADDB') {
    // For LEADDB: Use "Calling For" person's Calendly
    if (currentUser.callingFor) {
      const callingForName = currentUser.callingFor.toLowerCase().replace(/[^a-z]/g, '');
      calendlyUrl = `https://calendly.com/${callingForName}-ail/30min`;
    } else {
      calendlyUrl = currentUser.calendlyUrl || '';
    }
  }

  if (!calendlyUrl) {
    toast('No Calendly URL configured');
    return;
  }

  // Build URL with pre-filled info
  const phone = formatPhone(lead.phone);
  const name = encodeURIComponent(lead.name || '');
  const phoneInfo = encodeURIComponent(phone.pretty || lead.phone || '');
  
  const finalUrl = `${calendlyUrl}?name=${name}&a3=Phone: ${phoneInfo}`;
  
  window.open(finalUrl, '_blank');
  toast('Opening Calendly...');
}

// ============================================================
// UTILITIES
// ============================================================
function formatPhone(raw) {
  let digits = String(raw || '').replace(/\D/g, '');
  if (digits.length === 11 && digits.startsWith('1')) digits = digits.slice(1);
  if (digits.length !== 10) return { ok: false, digits: '', pretty: '‚Äî', tel: '#' };
  const pretty = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
  return { ok: true, digits, pretty, tel: `tel:+1${digits}` };
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

function exportLeads() {
  if (leads.length === 0) return;
  const headers = Object.keys(leads[0]);
  const csv = [headers.join(',')].concat(
    leads.map(l => headers.map(h => `"${String(l[h] || '').replace(/"/g, '""')}"`).join(','))
  ).join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${selectedSource.name}_export.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
